<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title id="app-title">Reproductor IPTV Web Moderno</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
/* ------------------------------------------------------------------- */
/* ESTILOS MODERNOS Y RESPONSIVOS */
/* ------------------------------------------------------------------- */
:root {
    --bg-dark: #121212; /* Fondo principal oscuro */
    --bg-medium: #212121; /* Fondo para controles y hover */
    --border-soft: #333; /* Separadores y bordes suaves */
    --accent-color: #00bcd4; /* Cian moderno */
}

body {
    background: var(--bg-dark);
    color: #fff;
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; /* Fuente moderna */
    display: flex;
    flex-direction: column; 
    height: 100vh;
    width: 100vw;
    margin: 0;
    overflow: hidden; 
    /* RTL Direction handled by JS on language switch */
}

/* Panel Izquierdo (Lista de Canales y Controles) */
#left {
    width: 100%;
    height: 50vh; 
    max-height: 50vh;
    display: flex;
    flex-direction: column;
    border-right: none;
    border-bottom: 1px solid var(--border-soft);
    transition: transform 0.3s ease-in-out;
    position: relative;
    z-index: 10;
}

/* Clase para ocultar el panel izquierdo en mÃ³vil */
#left.hidden {
    transform: translateY(-100%);
    height: 0;
    max-height: 0;
    overflow: hidden;
}

/* Contenedor de controles para aplicar espaciado moderno */
#controls-container {
    padding: 10px;
    background: var(--bg-dark);
    border-bottom: 1px solid var(--border-soft);
}

/* Controles (Selectores y Buscador) */
#language-select, #country-select, #category-select, #search {
    padding: 12px 10px; /* Mayor padding vertical */
    margin: 5px 0; /* Espacio entre controles */
    background: var(--bg-medium);
    border: 1px solid var(--border-soft);
    color: white;
    font-size: 15px;
    outline: none;
    width: 100%; 
    box-sizing: border-box;
    border-radius: 8px; /* Bordes redondeados modernos */
    appearance: none; 
}

#language-select {
    margin-bottom: 10px;
}

#list {
    flex: 1;
    overflow-y: auto;
}

/* Estilos de la lista */
.channel {
    padding: 12px;
    border-bottom: 1px solid var(--border-soft);
    cursor: pointer;
    transition: 0.3s ease;
    display: flex; 
    align-items: center;
    white-space: nowrap; 
    overflow: hidden; 
}
.channel:hover {
    background: var(--bg-medium);
    box-shadow: inset 0 0 10px rgba(0, 0, 0, 0.5); 
}

.active {
    background: #00bcd430 !important; 
    border-left: 5px solid var(--accent-color);
    box-shadow: 0 0 5px rgba(0, 188, 212, 0.5);
}

/* Estilo para el logo */
.channel-logo {
    width: 30px; 
    height: 30px;
    object-fit: contain; 
    margin-right: 10px;
    flex-shrink: 0; 
    border-radius: 4px;
}

/* Estilo para el nombre del canal */
.channel span {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
}


/* BotÃ³n para Mostrar/Ocultar la lista en mÃ³vil */
#toggle-list-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 20;
    padding: 10px 15px;
    background: var(--accent-color);
    color: var(--bg-dark); 
    border: none;
    border-radius: 8px; 
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: block; 
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
    transition: background 0.2s;
}
#toggle-list-btn:active {
    background: #008c9e; 
}

/* Reproductor de Video */
#player {
    flex: 1; 
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#video {
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    object-fit: contain; 
}


/* ------------------------------------------------------------------- */
/* MEDIA QUERY: ESCRITORIO (a partir de 768px) */
/* ------------------------------------------------------------------- */
@media (min-width: 768px) {
    body {
        flex-direction: row; 
    }

    #left {
        width: 320px; 
        height: 100%;
        max-height: 100%;
        border-right: 1px solid var(--border-soft);
        border-bottom: none;
        transform: none; 
    }

    /* Ocultar el botÃ³n en escritorio */
    #toggle-list-btn {
        display: none !important;
    }

    #left.hidden {
        transform: none;
        height: 100%;
        max-height: 100%;
        overflow: auto;
    }
}
</style>
</head>
<body>

<button id="toggle-list-btn">â˜° Canales</button>

<div id="left">
    <div id="controls-container">
        <select id="language-select" onchange="setLanguage(this.value)">
            <option value="es" selected>ðŸ‡ªðŸ‡¸ EspaÃ±ol</option>
            <option value="en">ðŸ‡¬ðŸ‡§ English</option>
            <option value="pt">ðŸ‡µðŸ‡¹ PortuguÃªs</option>
            <option value="ar">ðŸ‡¸ðŸ‡¦ Ø§Ù„Ø¹Ø±Ø¨ÙŠØ© (Arabic)</option>
        </select>

        <select id="country-select" onchange="filterChannels()">
            <option value="" id="opt-all-countries">Cargando PaÃ­ses...</option>
        </select>
        
        <select id="category-select" onchange="filterChannels()">
            <option value="" id="opt-all-categories">Cargando CategorÃ­as...</option>
        </select>
        
        <input type="text" id="search" placeholder="Buscar canal...">
    </div>
    
    <div id="list"></div>
</div>

<div id="player">
    <video id="video" controls width="100%" height="100%"></video>
</div>

<script>
// URLs
const M3U_URL = "https://iptv-org.github.io/iptv/index.m3u"; 
const COUNTRIES_API = "https://iptv-org.github.io/api/countries.json"; 

let allChannels = []; 
let channelsDOM = []; 
let countryMap = {}; 
let currentLang = 'es'; // Idioma por defecto

// Objeto de Traducciones
const translations = {
    es: {
        title: "Reproductor IPTV Web Moderno",
        allCountries: "ðŸŒ Todos los PaÃ­ses",
        allCategories: "â­ Todas las CategorÃ­as",
        searchPlaceholder: "Buscar canal...",
        loading: "Cargando lista de canales y datos...",
        noChannels: "No se encontraron canales vÃ¡lidos.",
        toggleOpen: "â˜° Canales",
        toggleClose: "X Cerrar",
        errorLoad: "Error al cargar los datos.",
        errorNoFilter: "No hay canales disponibles para el filtro actual.",
    },
    en: {
        title: "Modern IPTV Web Player",
        allCountries: "ðŸŒ All Countries",
        allCategories: "â­ All Categories",
        searchPlaceholder: "Search channel...",
        loading: "Loading channel list and data...",
        noChannels: "No valid channels found.",
        toggleOpen: "â˜° Channels",
        toggleClose: "X Close",
        errorLoad: "Error loading data.",
        errorNoFilter: "No channels available for current filter.",
    },
    pt: {
        title: "Reprodutor IPTV Web Moderno",
        allCountries: "ðŸŒ Todos os PaÃ­ses",
        allCategories: "â­ Todas as Categorias",
        searchPlaceholder: "Pesquisar canal...",
        loading: "Carregando lista de canais e dados...",
        noChannels: "Nenhum canal vÃ¡lido encontrado.",
        toggleOpen: "â˜° Canais",
        toggleClose: "X Fechar",
        errorLoad: "Erro ao carregar dados.",
        errorNoFilter: "NÃ£o hÃ¡ canais disponÃ­veis para o filtro atual.",
    },
    ar: {
        title: "Ù…Ø´ØºÙ„ IPTV ÙˆÙŠØ¨ Ø­Ø¯ÙŠØ«",
        allCountries: "ðŸŒ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ù„Ø¯Ø§Ù†",
        allCategories: "â­ Ø¬Ù…ÙŠØ¹ Ø§Ù„ÙØ¦Ø§Øª",
        searchPlaceholder: "Ø§Ø¨Ø­Ø« Ø¹Ù† Ù‚Ù†Ø§Ø©...",
        loading: "Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù‚Ù†ÙˆØ§Øª ÙˆØ§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...",
        noChannels: "Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ù‚Ù†ÙˆØ§Øª ØµØ§Ù„Ø­Ø©.",
        toggleOpen: "â˜° Ø§Ù„Ù‚Ù†ÙˆØ§Øª",
        toggleClose: "X Ø¥ØºÙ„Ø§Ù‚",
        errorLoad: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.",
        errorNoFilter: "Ù„Ø§ ØªÙˆØ¬Ø¯ Ù‚Ù†ÙˆØ§Øª Ù…ØªØ§Ø­Ø© Ù„Ù„ÙÙ„ØªØ± Ø§Ù„Ø­Ø§Ù„ÙŠ.",
    }
};

// Referencias a elementos DOM
const list = document.getElementById("list");
const countrySelect = document.getElementById("country-select");
const categorySelect = document.getElementById("category-select");
const searchInput = document.getElementById("search");
const leftPanel = document.getElementById("left");
const toggleBtn = document.getElementById("toggle-list-btn");


/**
 * Traduce todos los elementos visibles de la interfaz.
 */
function setLanguage(langCode) {
    currentLang = langCode;
    const t = translations[langCode];
    
    // 1. TÃ­tulo de la pÃ¡gina
    document.getElementById("app-title").innerText = t.title;

    // 2. Placeholder y Botones
    searchInput.placeholder = t.searchPlaceholder;
    if (leftPanel.classList.contains('hidden')) {
        toggleBtn.innerText = t.toggleOpen;
    } else {
        toggleBtn.innerText = t.toggleClose;
    }

    // 3. Opciones de PaÃ­s y CategorÃ­a
    document.getElementById("opt-all-countries").innerText = t.allCountries + (allChannels.length > 0 ? ` (${allChannels.length})` : '');
    document.getElementById("opt-all-categories").innerText = t.allCategories;

    // 4. DirecciÃ³n del texto (RTL para Ã¡rabe)
    document.body.style.direction = (langCode === 'ar') ? 'rtl' : 'ltr';
    // Ajustar el botÃ³n de mÃ³vil si la direcciÃ³n cambia
    if (langCode === 'ar') {
        toggleBtn.style.right = 'auto';
        toggleBtn.style.left = '10px';
    } else {
        toggleBtn.style.right = '10px';
        toggleBtn.style.left = 'auto';
    }
    
    // Opcional: Re-renderizar la lista si es necesario, pero solo cambiamos los selectores principales
    // Si la lista estÃ¡ mostrando un mensaje de error/carga, lo actualizamos.
    if (list.innerHTML.includes('Cargando')) {
         list.innerHTML = `<div style="padding: 10px; color: var(--accent-color);">${t.loading}</div>`;
    }
}


/**
 * FunciÃ³n auxiliar para extraer el valor de un atributo de la lÃ­nea EXTINF.
 */
const extractAttr = (line, attr) => {
    const match = line.match(new RegExp(attr + '="([^"]*)"'));
    return match ? match[1].trim() : '';
};

async function fetchData(url) {
    const response = await fetch(url);
    if (!response.ok) {
        throw new Error(`Error al obtener ${url}: ${response.statusText}`);
    }
    return response.json();
}

/**
 * Carga el archivo M3U, lo parsea y carga el mapa de paÃ­ses.
 */
async function loadList() {
    // Usamos la traducciÃ³n para el mensaje de carga
    list.innerHTML = `<div style="padding: 10px; color: var(--accent-color);">${translations[currentLang].loading}</div>`;
    
    try {
        const [m3uText, countriesData] = await Promise.all([
            fetch(M3U_URL).then(r => r.text()),
            fetchData(COUNTRIES_API)
        ]);
        
        // 1. Crear Mapa de PaÃ­ses (cÃ³digo -> nombre)
        countriesData.forEach(country => {
            countryMap[country.code.toUpperCase()] = country.name;
        });

        // 2. Parseo del M3U
        let lines = m3uText.split("\n");
        allChannels = [];
        const countries = new Set();
        const categories = new Set();
        
        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith("#EXTINF")) {
                let extinfLine = lines[i];
                let url = lines[i + 1] ? lines[i + 1].trim() : '';

                const name = extinfLine.split(",").pop().trim();
                const country = extractAttr(extinfLine, 'tvg-country').toUpperCase() || 'ZZ';
                const categoryName = extractAttr(extinfLine, 'group-title') || 'Otros';
                const logo = extractAttr(extinfLine, 'tvg-logo');

                if (name && url) {
                    allChannels.push({
                        name,
                        url,
                        country,
                        categoryName,
                        logo
                    });
                    countries.add(country);
                    categories.add(categoryName);
                }
            }
        }
        
        if (allChannels.length === 0) {
            list.innerHTML = `<div style="padding: 10px; color: red;">${translations[currentLang].noChannels}</div>`;
            return;
        }

        // 3. Poblar Selector de PaÃ­ses
        const optAllCountries = document.getElementById("opt-all-countries");
        optAllCountries.value = "";
        optAllCountries.innerText = translations[currentLang].allCountries + ` (${allChannels.length})`;
        
        countrySelect.innerHTML = '';
        countrySelect.appendChild(optAllCountries);

        Array.from(countries).sort().forEach(countryCode => {
            let name = countryMap[countryCode] || countryCode;
            let option = document.createElement("option");
            option.value = countryCode;
            option.innerText = name; 
            countrySelect.appendChild(option);
        });
        
        // 4. Poblar Selector de CategorÃ­as
        const optAllCategories = document.getElementById("opt-all-categories");
        optAllCategories.value = "";
        optAllCategories.innerText = translations[currentLang].allCategories;

        categorySelect.innerHTML = '';
        categorySelect.appendChild(optAllCategories);

        Array.from(categories).sort().forEach(categoryName => {
            let option = document.createElement("option");
            option.value = categoryName;
            option.innerText = categoryName;
            categorySelect.appendChild(option);
        });


        // 5. InicializaciÃ³n
        filterChannels(); 
        setupMobileToggle();

    } catch (error) {
        console.error("Error al cargar datos:", error);
        countrySelect.innerHTML = `<option value="">${translations[currentLang].errorLoad}</option>`;
        categorySelect.innerHTML = `<option value="">${translations[currentLang].errorLoad}</option>`;
        list.innerHTML = `<div style="padding: 10px; color: red;">${translations[currentLang].errorLoad}</div>`;
    }
}

/**
 * FunciÃ³n UNIFICADA para filtrar canales por PaÃ­s, CategorÃ­a y BÃºsqueda.
 */
function filterChannels() {
    const countryCode = countrySelect.value;
    const categoryName = categorySelect.value;
    const searchText = searchInput.value.toLowerCase();
    
    let channelsToShow = allChannels.filter(channel => {
        const matchesCountry = countryCode === '' || channel.country === countryCode;
        const matchesCategory = categoryName === '' || channel.categoryName === categoryName;
        const matchesSearch = channel.name.toLowerCase().includes(searchText);
        
        return matchesCountry && matchesCategory && matchesSearch;
    });

    renderChannels(channelsToShow);
}

/**
 * Renderiza los canales filtrados, incluyendo la lÃ³gica para el logo.
 */
function renderChannels(channelsToShow) {
    list.innerHTML = "";
    channelsDOM = [];

    if (channelsToShow.length === 0) {
        list.innerHTML = `<div style="padding: 10px; color: #ffeb3b;">${translations[currentLang].errorNoFilter}</div>`;
        return;
    }

    channelsToShow.forEach(channel => {
        let div = document.createElement("div");
        div.className="channel";
        div.dataset.url = channel.url;
        div.onclick = () => play(div);

        // IntegraciÃ³n del logo con correcciÃ³n de error de carga
        if (channel.logo) {
            const logoHtml = `<img src="${channel.logo}" class="channel-logo" alt="${channel.name} Logo" onerror="this.style.display='none';">`;
            const nameHtml = `<span>${channel.name}</span>`;
            div.innerHTML = logoHtml + nameHtml;
        } else {
            div.innerHTML = `<span>${channel.name}</span>`;
        }

        list.appendChild(div);
        channelsDOM.push(div);
    });
}


function play(div){
    // Ocultar la lista de canales al iniciar la reproducciÃ³n en mÃ³vil
    if (window.innerWidth < 768) {
        leftPanel.classList.add('hidden');
        toggleBtn.innerText = translations[currentLang].toggleOpen;
    }

    // Resaltar canal activo
    channelsDOM.forEach(c=>c.classList.remove("active"));
    div.classList.add("active");

    var url = div.dataset.url;
    var video = document.getElementById('video');

    if (Hls.isSupported()) {
        if(video.hls){
             video.hls.destroy(); 
        }
        var hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        video.hls = hls; 
        video.play();
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play();
    } else {
        alert("Video no compatible (HLS no soportado por este navegador).");
    }
}

/* ------------------------------------------------------------------- */
/* LÃ“GICA RESPONSIVA Y TOGGLE MÃ“VIL */
/* ------------------------------------------------------------------- */

function setupMobileToggle() {
    if (window.innerWidth < 768) {
        leftPanel.classList.add('hidden');
        toggleBtn.innerText = translations[currentLang].toggleOpen;
    }

    toggleBtn.addEventListener('click', () => {
        leftPanel.classList.toggle('hidden');
        const isHidden = leftPanel.classList.contains('hidden');
        toggleBtn.innerText = isHidden ? translations[currentLang].toggleOpen : translations[currentLang].toggleClose;
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            toggleBtn.style.display = 'none';
            leftPanel.classList.remove('hidden'); 
        } else {
            toggleBtn.style.display = 'block';
            const isHidden = leftPanel.classList.contains('hidden');
            toggleBtn.innerText = isHidden ? translations[currentLang].toggleOpen : translations[currentLang].toggleClose;
        }
    });
}

// Evento de bÃºsqueda llama al filtro unificado
searchInput.addEventListener("input", filterChannels);

// InicializaciÃ³n
setLanguage(document.getElementById('language-select').value); // Set default language texts
loadList();
</script>

</body>
</html>
