<!doctype html>
<html lang="es">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title id="app-title">IPTV Player</title>

<!-- PWA manifest (URL-encoded JSON, sin errores) -->
<link rel="manifest" href='data:application/json,%7B%22name%22%3A%22IPTV%20Player%22%2C%22short_name%22%3A%22IPTV%22%2C%22display%22%3A%22standalone%22%2C%22start_url%22%3A%22.%22%2C%22background_color%22%3A%22%230d1117%22%2C%22theme_color%22%3A%22%230d1117%22%2C%22icons%22%3A%5B%7B%22src%22%3A%22https%3A%2F%2Fcdn-icons-png.flaticon.com%2F512%2F633%2F633600.png%22%2C%22sizes%22%3A%22512x512%22%2C%22type%22%3A%22image%2Fpng%22%7D%5D%7D'>

<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png">
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png">

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg:#0d1117; --panel:#111419; --muted:#9ba7b2; --accent:#00c86b; --card:#0f1418;
  --radius:12px; --text:#e9eef1;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,Segoe UI,Roboto,Arial}
.app{display:flex;flex-direction:column;height:100vh;width:100vw;overflow:hidden}

/* HEADER */
.header{display:flex;align-items:center;justify-content:space-between;padding:12px 14px;gap:12px}
.logoTitle{display:flex;align-items:center;gap:10px}
.logoTitle img{width:36px;height:36px;border-radius:8px}
.title{font-weight:600}

/* LAYOUT */
.container{display:flex;flex-direction:column;flex:1;gap:8px;padding:0 12px 80px 12px}

/* LEFT PANEL */
.leftPanel{background:var(--panel);border-radius:var(--radius);padding:10px;max-height:44vh;overflow:hidden;transition:.3s}
.controls{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:8px}
.controls select,.controls input{flex:1;padding:10px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:#0b0f12;color:var(--muted)}
.controls .search{min-width:160px;flex:2}
.list{overflow:auto;max-height:calc(44vh - 120px);padding-right:6px}

/* CHANNEL ITEM */
.channel{display:flex;align-items:center;gap:12px;padding:8px;border-radius:10px;cursor:pointer;border:1px solid transparent}
@media(hover:hover){ .channel:hover{background:rgba(255,255,255,0.02);transform:translateX(6px);} }
.channel.active{background:linear-gradient(90deg, rgba(0,200,120,0.06), rgba(0,200,120,0.02));border:1px solid rgba(0,200,120,0.12)}
.logoWrap{width:44px;height:44px;border-radius:8px;background:rgba(255,255,255,0.03);display:flex;align-items:center;justify-content:center;flex-shrink:0;overflow:hidden}
.logoWrap img{width:100%;height:100%;object-fit:contain}
.chanName{overflow:hidden;white-space:nowrap;text-overflow:ellipsis;font-size:0.95rem}

/* PLAYER */
.playerWrap{flex:1;display:flex;flex-direction:column;gap:8px}
.videoCard{background:var(--card);border-radius:var(--radius);flex:1;display:flex;align-items:center;justify-content:center;position:relative;overflow:hidden}
video{width:100%;height:100%;background:#000;border-radius:10px}
.overlay{position:absolute;left:14px;top:14px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:8px;display:none}
.spinner{position:absolute;right:14px;top:14px;background:rgba(255,255,255,0.05);padding:6px 10px;border-radius:8px;display:none}

/* FULLSCREEN MENU */
#fsBtn{position:absolute;right:18px;bottom:18px;width:52px;height:52px;border-radius:999px;border:none;background:var(--accent);color:#04120b;font-size:24px;display:none;align-items:center;justify-content:center}
#fsMenu{position:absolute;right:18px;bottom:86px;background:rgba(10,10,10,0.98);padding:12px;border-radius:10px;width:300px;max-height:60vh;overflow:auto;display:none}
.fs-search{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);margin-bottom:8px;background:#070809;color:var(--text)}

/* BOTTOM NAV (MOBILE) */
.bottomNav{position:fixed;left:0;right:0;bottom:0;height:68px;background:#0b0c0d;display:flex;align-items:center;justify-content:space-around;border-top:1px solid rgba(255,255,255,0.03);z-index:60}
.btnNav{display:flex;flex-direction:column;align-items:center;gap:3px;color:var(--muted);font-size:12px;padding:8px}
.btnNav.active{color:var(--accent)}

/* DESKTOP */
@media(min-width:900px){
  .app{flex-direction:row}
  .leftPanel{flex:0 0 360px;max-height:none;height:100vh;overflow:auto}
  .bottomNav{display:none}
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <div class="logoTitle">
      <img src="https://cdn-icons-png.flaticon.com/512/633/633600.png">
      <div>
        <div class="title">IPTV Player</div>
        <div style="font-size:12px;color:#9ba7b2">Reproductor IPTV ‚Äî iptv-org</div>
      </div>
    </div>
    <button id="toggleBtn" style="background:var(--accent);border:none;padding:8px 12px;border-radius:10px;color:#04120b">‚ò∞</button>
  </div>

  <div class="container">

    <aside class="leftPanel" id="leftPanel">
      <div class="controls">
        <select id="countrySelect"><option value="">Cargando pa√≠ses‚Ä¶</option></select>
        <select id="categorySelect"><option value="">Categor√≠as</option></select>
        <input id="searchInput" class="search" placeholder="Buscar canal...">
      </div>
      <div class="list" id="channelList"></div>
    </aside>

    <section class="playerWrap">
      <div class="videoCard">
        <video id="player" controls playsinline></video>
        <div id="overlay" class="overlay"></div>
        <div id="spinner" class="spinner">Cargando‚Ä¶</div>

        <button id="fsBtn">‚â°</button>

        <div id="fsMenu">
          <input id="fsSearch" class="fs-search" placeholder="Buscar canal...">
          <div id="fsList"></div>
        </div>
      </div>
    </section>
  </div>

  <!-- Bottom Navigation -->
  <nav class="bottomNav" id="bottomNav">
    <div class="btnNav" id="nav-channels">‚ò∞<div>Canales</div></div>
    <div class="btnNav" id="nav-favs">‚òÖ<div>Favoritos</div></div>
    <div class="btnNav" id="nav-hist">‚ü≤<div>Historial</div></div>
  </nav>

</div>

<script>
/* ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
   CONFIG
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ*/
const API = {
  channels: "https://iptv-org.github.io/api/channels.json",
  streams:  "https://iptv-org.github.io/api/streams.json",
  countries:"https://iptv-org.github.io/api/countries.json",
  categories:"https://iptv-org.github.io/api/categories.json",
  m3u:      "https://iptv-org.github.io/iptv/index.country.m3u"
};

/* DOM */
const channelList = document.getElementById("channelList");
const countrySelect = document.getElementById("countrySelect");
const categorySelect = document.getElementById("categorySelect");
const searchInput = document.getElementById("searchInput");
const player = document.getElementById("player");
const overlay = document.getElementById("overlay");
const spinner = document.getElementById("spinner");
const leftPanel = document.getElementById("leftPanel");
const toggleBtn = document.getElementById("toggleBtn");

const fsBtn = document.getElementById("fsBtn");
const fsMenu = document.getElementById("fsMenu");
const fsSearch = document.getElementById("fsSearch");
const fsList = document.getElementById("fsList");

const navChannels = document.getElementById("nav-channels");
const navFavs     = document.getElementById("nav-favs");
const navHist     = document.getElementById("nav-hist");

/* STATE */
let hls = null;
let channels = [];
let favorites = JSON.parse(localStorage.getItem("iptv_favs") || "[]");
let history = JSON.parse(localStorage.getItem("iptv_hist") || "[]");

/* UTILS */
function extractAttr(line, key){
  const m = line.match(new RegExp(key+'="([^"]*)"','i'));
  return m ? m[1] : "";
}

function saveFavs(){ localStorage.setItem("iptv_favs", JSON.stringify(favorites)); }
function saveHist(){ localStorage.setItem("iptv_hist", JSON.stringify(history)); }

function showOverlay(text){
  overlay.textContent = text;
  overlay.style.display = "block";
  setTimeout(()=> overlay.style.display="none", 2000);
}

/* LOGO fallback */
function createLogo(logo,name){
  const wrap = document.createElement("div"); wrap.className = "logoWrap";
  if(logo){
    const img=document.createElement("img");
    img.src=logo; img.onerror=()=>{ img.remove(); wrap.textContent=name.slice(0,2); };
    wrap.appendChild(img);
  } else wrap.textContent = name.slice(0,2);
  return wrap;
}

/* LOAD CHANNELS */
async function loadChannels(){
  try{
    const [channelsJson, streamsJson, countriesJson, categoriesJson, m3uText] = await Promise.all([
      fetch(API.channels).then(r=>r.json()).catch(()=>null),
      fetch(API.streams).then(r=>r.json()).catch(()=>null),
      fetch(API.countries).then(r=>r.json()).catch(()=>null),
      fetch(API.categories).then(r=>r.json()).catch(()=>null),
      fetch(API.m3u).then(r=>r.text()).catch(()=>null)
    ]);

    const countryMap = {};
    if(countriesJson) countriesJson.forEach(c=> countryMap[c.code.toUpperCase()] = c.name);

    /* Build channel list */
    const result = [];

    if(channelsJson){
      channelsJson.forEach(c=>{
        let stream = null;
        const streams = streamsJson?.filter(s=>s.channel_id===c.id) || [];
        if(streams.length) stream = streams.find(s=>s.url.includes(".m3u8"))?.url || streams[0].url;

        result.push({
          name: c.name,
          logo: c.logo,
          country: (c.country||"").toUpperCase(),
          category: c.categories?.[0] || "",
          streamUrl: stream
        });
      });
    }

    /* fallback M3U missing streams */
    if(m3uText){
      const lines = m3uText.split("\n");
      for(let i=0;i<lines.length;i++){
        if(lines[i].startsWith("#EXTINF")){
          const L=lines[i];
          const name=L.split(",").pop();
          const logo=extractAttr(L,"tvg-logo");
          const country=extractAttr(L,"tvg-country").toUpperCase();
          const cat=extractAttr(L,"group-title");
          const url=lines[i+1]?.trim();
          i++;

          if(url && !result.some(x=>x.name===name)){
            result.push({name,logo,country,category:cat,streamUrl:url});
          }
        }
      }
    }

    /* filter invalid */
    channels = result.filter(x=>x.streamUrl);

    renderSelects(countryMap);
    renderList();
    renderFs(channels);

  }catch(e){
    console.error(e);
    channelList.innerHTML = "<div style='padding:12px;color:red'>Error cargando canales</div>";
  }
}

/* SELECT LISTS */
function renderSelects(countryMap){
  /* countries */
  const cset = [...new Set(channels.map(c=>c.country).filter(Boolean))];
  countrySelect.innerHTML = `<option value="">üåê Pa√≠ses (${channels.length})</option>`;
  cset.sort().forEach(code=>{
    const o=document.createElement("option");
    o.value=code; o.textContent=countryMap[code] || code;
    countrySelect.appendChild(o);
  });

  /* categories */
  const gset = [...new Set(channels.map(c=>c.category).filter(Boolean))];
  categorySelect.innerHTML = `<option value="">‚≠ê Categor√≠as</option>`;
  gset.sort().forEach(cat=>{
    const o=document.createElement("option");
    o.value=cat; o.textContent=cat;
    categorySelect.appendChild(o);
  });
}

/* RENDER LIST */
function renderList(){
  const country = countrySelect.value;
  const cat = categorySelect.value;
  const q=(searchInput.value||"").toLowerCase();

  const filtered = channels.filter(c=>{
    return (!country || c.country===country)
        && (!cat || c.category===cat)
        && (!q || c.name.toLowerCase().includes(q));
  });

  channelList.innerHTML="";
  filtered.forEach(ch=>{
    const item=document.createElement("div");
    item.className="channel";
    item.dataset.url=ch.streamUrl;

    const logo=createLogo(ch.logo,ch.name);
    const name=document.createElement("div");
    name.className="chanName"; name.textContent=ch.name;

    const fav=document.createElement("div");
    fav.style.marginLeft="auto";
    fav.style.fontSize="18px";
    fav.style.cursor="pointer";
    fav.textContent = favorites.includes(ch.streamUrl) ? "‚òÖ" : "‚òÜ";
    fav.onclick = e=>{
      e.stopPropagation();
      const k=ch.streamUrl;
      if(favorites.includes(k)) favorites = favorites.filter(x=>x!==k);
      else favorites.push(k);
      saveFavs();
      fav.textContent = favorites.includes(k) ? "‚òÖ" : "‚òÜ";
    };

    item.appendChild(logo);
    item.appendChild(name);
    item.appendChild(fav);
    item.onclick = ()=> playChannel(ch,item);

    channelList.appendChild(item);
  });
}

/* FS LIST */
function renderFs(list){
  fsList.innerHTML="";
  list.forEach(ch=>{
    const d=document.createElement("div");
    d.textContent = ch.name;
    d.style.padding="8px";
    d.style.cursor="pointer";
    d.onclick = ()=>{ playChannel(ch); fsMenu.style.display="none"; };
    fsList.appendChild(d);
  });
}

/* PLAY */
async function playChannel(ch,el){
  const url = ch.streamUrl;
  if(!url){ alert("Canal sin URL"); return; }

  document.querySelectorAll(".channel").forEach(c=>c.classList.remove("active"));
  if(el) el.classList.add("active");

  if(window.innerWidth < 900){
    leftPanel.style.transform = "translateY(-110%)";
    toggleBtn.textContent="‚ò∞";
  }

  showOverlay(ch.name);
  spinner.style.display="block";

  try{
    if(hls){ hls.destroy(); hls = null; }
    player.src="";

    if(url.includes(".m3u8") && Hls.isSupported()){
      hls=new Hls(); hls.loadSource(url); hls.attachMedia(player);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>{ spinner.style.display="none"; player.play().catch(()=>{}); });
    } else {
      player.src=url;
      await player.play();
      spinner.style.display="none";
    }

    history = history.filter(h=>h!==url);
    history.unshift(url);
    if(history.length>200) history.length = 200;
    saveHist();

  }catch(e){
    spinner.style.display="none";
    console.error(e);
    alert("No se puede reproducir este canal.");
  }
}

/* SEARCH */
searchInput.oninput = ()=> renderList();
fsSearch.oninput = ()=>{
  const q=fsSearch.value.toLowerCase();
  [...fsList.children].forEach(n=>{
    n.style.display = n.textContent.toLowerCase().includes(q) ? "block" : "none";
  });
};

/* MOBILE LEFT PANEL */
toggleBtn.onclick = ()=>{
  if(leftPanel.style.transform==="translateY(-110%)"){
    leftPanel.style.transform="";
    toggleBtn.textContent="X";
  } else {
    leftPanel.style.transform="translateY(-110%)";
    toggleBtn.textContent="‚ò∞";
  }
};

/* FULLSCREEN */
document.addEventListener("fullscreenchange",()=>{
  fsBtn.style.display = document.fullscreenElement ? "flex" : "none";
});
fsBtn.onclick = ()=>{
  fsMenu.style.display = fsMenu.style.display==="block"?"none":"block";
};

/* BOTTOM NAVIGATION */
navChannels.onclick = ()=>{ renderList(); renderFs(channels); };
navFavs.onclick = ()=>{
  const favs = channels.filter(c=>favorites.includes(c.streamUrl));
  channelList.innerHTML="";
  favs.forEach(c=>{
    const item=document.createElement("div");
    item.className="channel";
    item.onclick = ()=>playChannel(c,item);
    item.appendChild(createLogo(c.logo,c.name));
    const t=document.createElement("div"); t.className="chanName"; t.textContent=c.name;
    item.appendChild(t);
    channelList.appendChild(item);
  });
  renderFs(favs);
};
navHist.onclick = ()=>{
  const hist = history.map(u=>channels.find(c=>c.streamUrl===u)).filter(Boolean);
  channelList.innerHTML="";
  hist.forEach(c=>{
    const item=document.createElement("div");
    item.className="channel";
    item.onclick = ()=>playChannel(c,item);
    item.appendChild(createLogo(c.logo,c.name));
    const t=document.createElement("div"); t.className="chanName"; t.textContent=c.name;
    item.appendChild(t);
    channelList.appendChild(item);
  });
  renderFs(hist);
};

/* SERVICE WORKER (FIXED) */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{
    const sw = `
      self.addEventListener('install', e=>self.skipWaiting());
      self.addEventListener('fetch', e=>{
        e.respondWith(fetch(e.request).catch(()=>new Response('<h2>Offline</h2>',{headers:{'Content-Type':'text/html'}})));
      });
    `;
    navigator.serviceWorker.register(URL.createObjectURL(new Blob([sw],{type:"text/javascript"})));
  });
}

/* INIT */
loadChannels();
</script>

</body>
</html>