<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title id="app-title">IPTV PLAYER</title>

<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png" />
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png" />
<meta name="theme-color" content="#0a0a0a" />
<link rel="manifest" href='data:application/json,{"name":"IPTV Player","short_name":"IPTV","start_url":".","display":"standalone","background_color":"#0a0a0a","theme_color":"#0a0a0a","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/633/633600.png","sizes":"512x512","type":"image/png"}]}'>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
/* ----------------------------------------------------
   Variables y Reset (Cinematic TV Theme)
   ---------------------------------------------------- */
:root{
  --bg-dark:#0a0a0a; /* Pure black */
  --bg-medium:#151515; /* Background for list/controls */
  --bg-light:#282828; /* Hover state */
  --border-soft:#333;
  --accent:#00ccff; /* Bright Cyan (TV menu highlight) */
  --text:#f0f0f0;
  --text-soft:#aaaaaa;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg-dark);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif;font-size:16px}
body{display:flex;flex-direction:column;overflow:hidden}
.app{display:flex;flex-direction:column;height:100vh;width:100vw;gap:0}

/* ----------------------------------------------------
   Left Panel (List) - TV Sidebar/Overlay
   ---------------------------------------------------- */
#left{
  width:100%;
  height:calc(100vh - 62px); /* Mobile: Full height minus bottom menu */
  max-height:100vh;
  background:var(--bg-medium); /* Slightly lighter background than body */
  padding:16px;
  overflow:hidden;
  transition:transform .3s ease-in-out;
  position:fixed; 
  top:0;
  left:0;
  z-index:50;
  /* Slides in from left (TV Menu style on mobile) */
  transform:translateX(-100%); 
}
#left.active{
    transform:translateX(0); /* Show when active */
}

/* Controls Container - Minimalist look */
#controls-container{display:flex;flex-direction:column;gap:8px;margin-bottom:12px;padding-top:40px} 
select,input{
  width:100%;
  padding:10px 12px;
  border-radius:6px;
  border:none; /* Minimalist: remove borders */
  background:var(--bg-dark);
  color:var(--text);
  outline:none;
  transition:all .2s;
}
select:focus,input:focus{
    box-shadow:0 0 0 2px var(--accent); /* Thin accent ring on focus */
}

/* List container */
#list{overflow-y:auto;height:calc(100% - 220px);padding-right:8px}

/* Channel items - TV Menu Look */
.channel{
  display:flex;
  align-items:center;
  gap:16px;
  padding:14px 12px;
  margin-bottom:4px; 
  border-radius:4px; 
  cursor:pointer;
  background:var(--bg-medium);
  transition:all .2s ease-out;
  box-shadow:none;
  border-bottom:none; /* Remove bottom border for cleaner look */
}
.channel:hover{
    background:var(--bg-light); /* Subtle hover */
}
.channel.active{
  background:var(--bg-light); 
  border:1px solid var(--accent); 
  box-shadow:0 0 10px rgba(0,204,255,0.7); /* Strong glow effect for selection */
  font-weight:600;
  /* Quita el color de fondo en la seleccion para un look mas limpio */
  background:var(--bg-light); 
  border-left:none; /* Quita el borde vertical de la versi√≥n anterior */
}
.channel-logo{
  width:40px; 
  height:40px;
  border-radius:4px;
  flex-shrink:0;
  background:var(--bg-dark);
  display:flex;
  align-items:center;
  justify-content:center;
  overflow:hidden;
}
.channel-logo img{width:100%;height:100%;object-fit:contain;display:block}
.channel-name{
  white-space:nowrap;
  overflow:hidden;
  text-overflow:ellipsis;
  color:var(--text);
}
/* Estilo para el bot√≥n de favorito */
.favorite-toggle{
  margin-left:auto;
  cursor:pointer;
  color:var(--accent);
  font-size:1.2em;
  padding-left:10px;
  flex-shrink:0;
}

/* ----------------------------------------------------
   Right Panel (Player) - Full screen focus
   ---------------------------------------------------- */
#playerWrap{
  flex:1;
  background:#000; /* Pure black */
  display:flex;
  align-items:center;
  justify-content:center;
  padding:0; /* Maximized video space */
  position:relative;
  min-height:calc(100vh - 62px); 
}
video{
    width:100%;
    height:100%;
    max-height:100vh;
    border-radius:0; /* Full screen look */
    background:#000;
    outline:none;
    box-shadow:none;
}
.overlay{position:absolute;top:20px;left:20px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:4px;display:none;color:#ffeded}
.spinnerSmall{position:absolute;right:20px;top:20px;padding:6px 10px;border-radius:4px;background:rgba(255,255,255,0.08);color:var(--text);display:none}

/* Fullscreen Button and Menu styles remain for UX */
#fsBtn{position:absolute;bottom:20px;right:20px;background:var(--accent);border:none;color:var(--bg-dark);width:48px;height:48px;border-radius:999px;font-size:18px;display:none;align-items:center;justify-content:center;cursor:pointer;}
#fsMenu{position:absolute;bottom:78px;right:20px;background:rgba(10,10,10,0.98);padding:10px;border-radius:6px;width:260px;max-height:60vh;overflow:auto;display:none;}
.fs-search{background:var(--bg-medium);color:var(--text);border:none;border-radius:4px;padding:8px;}

/* ----------------------------------------------------
   NUEVO MODAL DE FAVORITOS
   ---------------------------------------------------- */
#favoritesModal {
    position: fixed;
    top: 0;
    left: 0;
    width: 100vw;
    height: 100vh;
    background: rgba(0, 0, 0, 0.9); /* Oscurece el fondo */
    z-index: 100; /* Asegura que est√© por encima de todo */
    display: flex;
    align-items: center;
    justify-content: center;
    padding: 20px;
}
.modal-content {
    background: var(--bg-medium);
    border-radius: 8px;
    padding: 20px;
    width: 90%;
    max-width: 500px;
    max-height: 90%;
    display: flex;
    flex-direction: column;
    position: relative;
    box-shadow: 0 0 20px rgba(0, 204, 255, 0.3);
}
.modal-content h2 {
    color: var(--accent);
    margin-top: 0;
    margin-bottom: 15px;
    font-size: 1.5em;
}
#favoritesList {
    overflow-y: auto;
    flex-grow: 1;
    padding-right: 10px;
}
#favoritesList .channel { 
    background: var(--bg-dark);
    margin-bottom: 8px;
    padding: 10px 14px;
    display: flex;
    justify-content: space-between;
    align-items: center;
}
/* Ocultamos el icono de favorito en el modal para usar el icono de eliminar */
#favoritesList .channel .channel-logo { display: none; }
#favoritesList .channel .favorite-toggle { display: none; }

.modal-close-btn {
    position: absolute;
    top: 10px;
    right: 10px;
    background: var(--bg-dark);
    color: var(--text);
    border: 1px solid var(--border-soft);
    border-radius: 4px;
    padding: 5px 10px;
    cursor: pointer;
    font-weight: bold;
    font-size: 1.1em;
    line-height: 1;
}

/* ----------------------------------------------------
   Mobile UI (Bottom Bar & Toggle Button)
   ---------------------------------------------------- */
#toggle-list-btn{
  position:fixed;top:10px;right:10px;z-index:60;padding:8px 12px;background:var(--accent);color:var(--bg-dark);border:none;border-radius:4px;cursor:pointer;font-weight:600;
}
#bottomMenu{
  position:fixed;left:0;right:0;bottom:0;height:62px;
  background:var(--bg-medium);
  display:flex;align-items:center;justify-content:space-around;border-top:1px solid var(--border-soft);z-index:55;
}
.menu-btn{display:flex;flex-direction:column;align-items:center;font-size:12px;color:var(--text-soft);gap:4px;cursor:pointer}
.menu-btn.active{color:var(--accent);font-weight:600}

/* ----------------------------------------------------
   Desktop Responsiveness (PC) - Narrower Sidebar
   ---------------------------------------------------- */
@media(min-width:900px){
  .app{flex-direction:row}

  /* Left panel is fixed, narrower, and uses a medium background for contrast */
  #left{
    width:300px; /* Narrower sidebar for minimalist look */
    height:100%;
    max-height:100%;
    position:relative;
    transform:none; /* Always visible on desktop */
    border-right:1px solid var(--border-soft);
    padding:16px;
    background:var(--bg-medium);
  }
  #controls-container{padding-top:0} 
  #list{height:calc(100% - 190px)} 

  /* Player is full screen in its container */
  #playerWrap{flex:1;padding:0;min-height:100vh}

  /* Remove mobile elements */
  #toggle-list-btn{display:none}
  #bottomMenu{display:none}
}
</style>
</head>
<body>
<button id="toggle-list-btn" aria-label="Mostrar lista">‚ò∞ Canales</button>

<div class="app" id="app">
  <aside id="left">
    <div id="controls-container">
      <select id="language-select" onchange="setLanguage(this.value)">
        <option value="es" selected>üá™üá∏ Espa√±ol</option>
        <option value="en">üá¨üáß English</option>
        <option value="pt">üáµüáπ Portugu√™s</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      </select>

      <select id="country-select" onchange="filterChannels()">
        <option value="" id="opt-all-countries">Cargando Pa√≠ses...</option>
      </select>

      <select id="category-select" onchange="filterChannels()">
        <option value="" id="opt-all-categories">Cargando Categor√≠as...</option>
      </select>

      <input id="search" placeholder="Buscar canal..." />
    </div>

    <div id="list" role="listbox" aria-label="Lista de canales"></div>
  </aside>

  <main id="playerWrap">
    <div style="width:100%;height:100%;max-width:1400px;max-height:100vh;position:relative">
      <video id="video" controls playsinline crossorigin="anonymous"></video>
      <div id="overlay" class="overlay" role="status" aria-hidden="true"></div>
      <div id="spinner" class="spinnerSmall" aria-hidden="true">Cargando‚Ä¶</div>

      <button id="fsBtn" title="Abrir lista" aria-label="Abrir lista">üì∫</button>
      <div id="fsMenu" aria-hidden="true">
        <input id="fsSearch" class="fs-search" placeholder="Buscar canal..." />
        <div id="fsList"></div>
      </div>
    </div>
    
    <div id="favoritesModal" style="display:none;" aria-hidden="true">
        <div class="modal-content">
            <h2>‚òÖ Favoritos</h2>
            <div id="favoritesList"></div>
            <button id="closeFavModal" class="modal-close-btn" aria-label="Cerrar favoritos">X</button>
        </div>
    </div>
    
  </main>
</div>

<nav id="bottomMenu" aria-hidden="false">
  <div class="menu-btn" id="btn-channels">‚ò∞<span>Canales</span></div>
  <div class="menu-btn" id="btn-favs">‚òÖ<span>Favoritos</span></div>
  <div class="menu-btn" id="btn-hist">‚ü≤<span>Historial</span></div>
</nav>

<script>
/* ---------------------------
   Configuraci√≥n y elementos
   --------------------------- */
const M3U_URL = "https://iptv-org.github.io/iptv/index.m3u";
const COUNTRIES_API = "https://iptv-org.github.io/api/countries.json";
const video = document.getElementById('video');
const listEl = document.getElementById('list');
const countrySelect = document.getElementById('country-select');
const categorySelect = document.getElementById('category-select');
const searchInput = document.getElementById('search');
const overlay = document.getElementById('overlay');
const spinner = document.getElementById('spinner');
const toggleBtn = document.getElementById('toggle-list-btn');
const leftPanel = document.getElementById('left');
const fsBtn = document.getElementById('fsBtn');
const fsMenu = document.getElementById('fsMenu');
const fsList = document.getElementById('fsList');
const fsSearch = document.getElementById('fsSearch');
const optAllCountries = document.getElementById('opt-all-countries');
const optAllCategories = document.getElementById('opt-all-categories');
// NEW: Favorite Modal Elements
const favoritesModal = document.getElementById('favoritesModal');
const favoritesListContainer = document.getElementById('favoritesList');


let hls = null;
let allChannels = [];
let channelsDOM = [];
let countriesMap = {};
let favorites = JSON.parse(localStorage.getItem('iptv_favs')||'[]');
let historyList = JSON.parse(localStorage.getItem('iptv_hist')||'[]');
let currentLang = 'es';

/* ---------- Internationalization (small) ---------- */
const translations = {
  es:{ 
    loading:"Cargando lista...", noChannels:"No se encontraron canales.", toggleOpen:"‚ò∞ Canales", toggleClose:"X Cerrar", search:"Buscar canal...", errorNative:"No se pudo reproducir este canal (Nativo).",
    favAdd: 'A√±adir a Favoritos', favRemove: 'Quitar de Favoritos'
  },
  en:{ 
    loading:"Loading list...", noChannels:"No channels found.", toggleOpen:"‚ò∞ Channels", toggleClose:"X Close", search:"Search channel...", errorNative:"Could not play this channel (Native).",
    favAdd: 'Add to Favorites', favRemove: 'Remove from Favorites'
  },
  pt:{ 
    loading:"Carregando lista...", noChannels:"Nenhum canal encontrado.", toggleOpen:"‚ò∞ Canais", toggleClose:"X Fechar", search:"Pesquisar canal...", errorNative:"N√£o foi poss√≠vel reproduzir este canal (Nativo).",
    favAdd: 'Adicionar aos Favoritos', favRemove: 'Remover dos Favoritos'
  },
  ar:{ 
    loading:"ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", noChannels:"ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ŸÇŸÜŸàÿßÿ™.", toggleOpen:"‚ò∞ ÿßŸÑŸÇŸÜŸàÿßÿ™", toggleClose:"X ÿ•ÿ∫ŸÑÿßŸÇ", search:"ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇŸÜÿßÿ©...", errorNative:"ÿ™ÿπÿ∞ÿ± ÿ™ÿ¥ÿ∫ŸäŸÑ Ÿáÿ∞Ÿá ÿßŸÑŸÇŸÜÿßÿ© (ÿ£ÿµŸÑŸä).",
    favAdd: 'ÿ£ÿ∂ŸÅ ÿ•ŸÑŸâ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©', favRemove: 'ÿ•ÿ≤ÿßŸÑÿ© ŸÖŸÜ ÿßŸÑŸÖŸÅÿ∂ŸÑÿ©'
  }
};

/* ---------- Utility ---------- */
function setLanguage(lang){
  currentLang = lang;
  const t = translations[lang] || translations.es;
  document.getElementById('app-title').innerText = (lang==='en' ? 'Modern IPTV Web Player' : 'Reproductor IPTV Web Moderno');
  searchInput.placeholder = t.search;
  // Update toggle button text based on the new 'active' class
  toggleBtn.innerText = leftPanel.classList.contains('active') ? t.toggleClose : t.toggleOpen;
  optAllCountries.textContent = (lang==='en'?'üåê All Countries':'üåê Todos los Pa√≠ses') + (allChannels.length?` (${allChannels.length})`:'');
  optAllCategories.textContent = (lang==='en'?'‚≠ê All Categories':'‚≠ê Todas las Categor√≠as');
  // RTL for Arabic
  document.documentElement.dir = (lang==='ar') ? 'rtl' : 'ltr';
}

/* ---------- Fetch helpers ---------- */
async function fetchJSON(url){
  const r = await fetch(url);
  if(!r.ok) throw new Error('Fetch failed: '+url);
  return r.json();
}

/* ---------- Parse M3U (lightweight) ---------- */
function extractAttr(line, key){
  const re = new RegExp(key+'="([^"]*)"','i');
  const m = line.match(re);
  return m ? m[1].trim() : '';
}

async function loadList(){
  listEl.innerHTML = `<div style="padding:12px;color:var(--accent)">${translations[currentLang].loading}</div>`;
  try{
    const [m3uText, countriesData] = await Promise.all([
      fetch(M3U_URL).then(r=>r.text()),
      fetchJSON(COUNTRIES_API).catch(()=>[])
    ]);

    // build country map
    (countriesData||[]).forEach(c=>{ if(c.code) countriesMap[c.code.toUpperCase()] = c.name; });

    const lines = m3uText.split(/\r?\n/);
    allChannels = [];
    const countries = new Set();
    const categories = new Set();

    for(let i=0;i<lines.length;i++){
      const L = lines[i].trim();
      if(!L) continue;
      if(L.startsWith('#EXTINF')){
        const name = (L.includes(',') ? L.substring(L.indexOf(',')+1).trim() : '');
        const logo = extractAttr(L,'tvg-logo') || extractAttr(L,'logo') || null;
        const country = (extractAttr(L,'tvg-country') || extractAttr(L,'country') || '').toUpperCase() || 'OTROS';
        const group = extractAttr(L,'group-title') || 'Otros';
        // next non-empty line for URL
        let j = i+1;
        while(j<lines.length && !lines[j].trim()) j++;
        const url = (lines[j]||'').trim();
        i = j;
        if(name && url){
          allChannels.push({name,logo,url,country,group});
          countries.add(country);
          categories.add(group);
        }
      }
    }

    if(allChannels.length===0){
      listEl.innerHTML = `<div style="padding:12px;color:#ff6b6b">${translations[currentLang].noChannels}</div>`;
      return;
    }

    // populate selectors
    optAllCountries.textContent = (currentLang==='en'?'üåê All':'üåê Todos') + ` (${allChannels.length})`;
    countrySelect.innerHTML = '';
    countrySelect.appendChild(optAllCountries);
    Array.from(countries).sort().forEach(c=>{
      const o = document.createElement('option'); o.value = c; o.textContent = countriesMap[c] || c; countrySelect.appendChild(o);
    });

    optAllCategories.textContent = (currentLang==='en'?'‚≠ê All Categories':'‚≠ê Todas las Categor√≠as');
    categorySelect.innerHTML = '';
    categorySelect.appendChild(optAllCategories);
    Array.from(categories).sort().forEach(g=>{
      const o = document.createElement('option'); o.value = g; o.textContent = g; categorySelect.appendChild(o);
    });

    renderChannels(allChannels);
    // fill fs list (for fullscreen menu)
    renderFsList(allChannels);
  }catch(err){
    console.error(err);
    listEl.innerHTML = `<div style="padding:12px;color:#ff6b6b">Error cargando lista</div>`;
  }
}

/* ---------- Favorites Logic ---------- */
function toggleFavorite(ch, starEl) {
    const t = translations[currentLang];
    const url = ch.url;
    const isFav = favorites.includes(url);
    let channelElementInMainList = null;

    // Find the corresponding element in the main sidebar list
    if(ch.name) {
       channelElementInMainList = channelsDOM.find(el => el.dataset.url === url);
    } else {
        // If 'ch' is just an object with a URL (from the modal), we need to find the star element by URL
        channelElementInMainList = channelsDOM.find(el => el.dataset.url === url);
        if (channelElementInMainList) {
             starEl = channelElementInMainList.querySelector('.favorite-toggle');
        }
    }


    if (isFav) {
        favorites = favorites.filter(u => u !== url);
        if(starEl) { // Update star in the sidebar
            starEl.innerHTML = '‚òÜ'; 
            starEl.title = t.favAdd;
        }
    } else {
        favorites.push(url);
        if(starEl) { // Update star in the sidebar
            starEl.innerHTML = '‚òÖ'; 
            starEl.title = t.favRemove;
        }
    }
    localStorage.setItem('iptv_favs', JSON.stringify(favorites));

    // If the modal is open, re-render it
    if(favoritesModal.style.display === 'flex') {
        showFavoritesModal();
    }
}

/* ---------- Render functions ---------- */
function createChannelElement(ch){
  const el = document.createElement('div');
  el.className = 'channel';
  el.tabIndex = 0;
  el.dataset.url = ch.url;
  el.dataset.name = ch.name;
  el.dataset.country = ch.country;
  el.dataset.group = ch.group;

  const logo = document.createElement('div'); logo.className = 'channel-logo';
  if(ch.logo){
    const img = document.createElement('img'); img.src = ch.logo; img.alt = ch.name + ' logo';
    img.onerror = ()=>{ img.remove(); logo.textContent = ch.name.slice(0,2).toUpperCase(); };
    logo.appendChild(img);
  } else {
    logo.textContent = ch.name.slice(0,2).toUpperCase();
  }

  const name = document.createElement('div'); name.className = 'channel-name'; name.textContent = ch.name;

  // Favorite Toggle Button (in main list)
  const t = translations[currentLang];
  const isFav = favorites.includes(ch.url);
  const favBtn = document.createElement('span');
  favBtn.className = 'favorite-toggle';
  favBtn.innerHTML = isFav ? '‚òÖ' : '‚òÜ';
  favBtn.title = isFav ? t.favRemove : t.favAdd;
  
  favBtn.addEventListener('click', (e) => {
      e.stopPropagation(); // Prevents playChannel from firing when clicking the star
      toggleFavorite(ch, favBtn);
  });
  
  // click & keyboard
  el.appendChild(logo); 
  el.appendChild(name);
  el.appendChild(favBtn); // Add the favorite button
  el.addEventListener('click', ()=>playChannel(ch,el));
  el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') playChannel(ch,el); });

  return el;
}

function renderChannels(list){
  listEl.innerHTML = '';
  channelsDOM = [];
  if(!list || list.length===0){
    listEl.innerHTML = `<div style="padding:12px;color:#ffd166">No hay canales para este filtro.</div>`;
    return;
  }
  // render lightweight: avoid heavy DOM work by appending fragment
  const frag = document.createDocumentFragment();
  for(const ch of list){
    const el = createChannelElement(ch);
    frag.appendChild(el);
    channelsDOM.push(el);
  }
  listEl.appendChild(frag);
}

/* fullscreen menu list */
function renderFsList(list){
  fsList.innerHTML = '';
  const frag = document.createDocumentFragment();
  for(const ch of list){
    const el = document.createElement('div');
    el.style.padding = '8px'; el.style.cursor = 'pointer'; el.style.borderRadius = '6px';
    el.textContent = ch.name;
    el.onclick = ()=>{ playChannel(ch,null); fsMenu.style.display='none'; };
    frag.appendChild(el);
  }
  fsList.appendChild(frag);
}

/* ---------- FAVORITES MODAL LOGIC (NEW) ---------- */
function createModalChannelElement(ch) {
    const el = document.createElement('div');
    el.className = 'channel';
    
    const nameEl = document.createElement('span');
    nameEl.className = 'channel-name';
    nameEl.textContent = ch.name;
    
    const removeBtn = document.createElement('span');
    removeBtn.textContent = '‚ùå';
    removeBtn.style.cursor = 'pointer';
    removeBtn.style.marginLeft = '10px';
    removeBtn.title = translations[currentLang].favRemove;
    
    // Remove from favorites handler
    removeBtn.addEventListener('click', (e) => {
        e.stopPropagation(); // Prevent playing channel
        // Pass a minimal object to toggleFavorite as it expects 'ch'
        toggleFavorite({ url: ch.url }, el); 
        // Re-render the modal list after removal
        showFavoritesModal();
    });

    el.appendChild(nameEl);
    el.appendChild(removeBtn);
    
    // Play channel handler
    el.addEventListener('click', () => {
        playChannel(ch, null); // Play channel
        favoritesModal.style.display = 'none'; // Close modal
        favoritesModal.setAttribute('aria-hidden', 'true');
        setActiveMenuButton(null); // Deselect button
    });
    return el;
}

function renderFavoritesModalList(list) {
    favoritesListContainer.innerHTML = '';
    if (!list || list.length === 0) {
        favoritesListContainer.innerHTML = `<div style="padding:10px;color:var(--text-soft);">No tienes canales favoritos guardados.</div>`;
        return;
    }
    
    const frag = document.createDocumentFragment();
    for (const ch of list) {
        const el = createModalChannelElement(ch);
        frag.appendChild(el);
    }
    favoritesListContainer.appendChild(frag);
}

function showFavoritesModal() {
    setActiveMenuButton('btn-favs');
    
    // 1. Filter the favorites list
    const favs = allChannels.filter(c => favorites.includes(c.url));
    
    // 2. Populate and render the modal content
    renderFavoritesModalList(favs);
    
    // 3. Display the modal
    favoritesModal.style.display = 'flex';
    favoritesModal.setAttribute('aria-hidden', 'false');

    // On mobile, ensure the left panel is hidden
    if (window.innerWidth < 900 && leftPanel.classList.contains('active')) {
        leftPanel.classList.remove('active');
        toggleBtn.textContent = translations[currentLang].toggleOpen;
        setActiveMenuButton('btn-favs'); 
    }
}
/* ----------------------------------------------------------------- */


/* ---------- Playback: M3U, M3U8, H264 Compatibility ---------- */
async function playChannel(ch, el){
  const t = translations[currentLang];

  // LOGIC FOR HISTORY
  const urlIndex = historyList.indexOf(ch.url);
  if (urlIndex !== -1) {
      historyList.splice(urlIndex, 1); 
  }
  historyList.unshift(ch.url); 
  historyList = historyList.slice(0, 50); 
  localStorage.setItem('iptv_hist', JSON.stringify(historyList));


  // select UI
  channelsDOM.forEach(c=>c.classList.remove('active'));
  if(el) el.classList.add('active');

  // hide left on small screens (TV Menu behavior)
  if(window.innerWidth < 900) { 
    leftPanel.classList.remove('active'); 
    toggleBtn.innerText = t.toggleOpen || '‚ò∞ Canales'; 
  }

  // show overlay with name for 3s
  overlay.textContent = ch.name;
  overlay.style.display = 'block';
  overlay.setAttribute('aria-hidden','false');
  setTimeout(()=>{ overlay.style.display = 'none'; overlay.setAttribute('aria-hidden','true'); }, 3000);

  // spinner show
  spinner.style.display = 'block';
  spinner.setAttribute('aria-hidden','false');

  // Cleanup previous HLS and video element before load
  try{ 
    if(hls){ hls.destroy(); hls = null; } 
    video.pause(); 
    video.removeAttribute('src'); 
    video.load(); // Force reset video element
  }catch(e){ console.warn("Cleanup failed", e); }


  const url = ch.url;

  // Helper: try playing via <video> first for direct MP4/TS/others (H264 Native support)
  function tryNativePlay(src){
    return new Promise((resolve, reject)=>{
      video.src = src;
      const p = video.play();
      if(p && p.then){
        p.then(()=>resolve()).catch(err=>reject(err));
      }else{
        // older browsers
        resolve();
      }
    });
  }

  // Determine probable type (best-effort)
  const u = url.split('?')[0].toLowerCase();
  const isM3U8 = u.endsWith('.m3u8') || u.includes('.m3u8');
  const isMPD  = u.endsWith('.mpd') || u.includes('.mpd');
  const isRtsp = u.startsWith('rtsp:');
  const isRtmp = u.startsWith('rtmp:');

  try{
    // RTSP/RTMP cannot be played in browser directly
    if(isRtsp || isRtmp || isMPD){
      spinner.style.display='none';
      alert('Este stream no es reproducible directamente en navegadores (RTSP/RTMP/DASH).');
      return;
    }


    // HLS streams (m3u8) - Supports H264 over TS/fMP4
    if(isM3U8){
      if(Hls.isSupported()){
        hls = new Hls({
          maxBufferLength: 30,
          enableWorker: true,
          manifestLoadingRetryDelay: 1000,
          fragLoadingRetryDelay: 1200
        });
        hls.loadSource(url);
        hls.attachMedia(video);

        hls.on(Hls.Events.MANIFEST_PARSED, ()=>{ 
            spinner.style.display='none'; 
            spinner.setAttribute('aria-hidden','true'); 
            video.play().catch(()=>{}); 
        });

        // Error handling with fallback to native
        hls.on(Hls.Events.ERROR, function(event, data){
          console.warn('HLS error',data);
          if(data.fatal){
            try{ hls.destroy(); }catch(e){}
            hls = null;
            tryNativePlay(url)
              .then(()=>{ spinner.style.display='none'; })
              .catch(()=>{ spinner.style.display='none'; alert(t.errorNative); }); 
          }
        });
        return;
      } else if(video.canPlayType('application/vnd.apple.mpegurl')){
        // Safari native HLS
        tryNativePlay(url)
          .then(()=>{ spinner.style.display='none'; })
          .catch(()=>{ spinner.style.display='none'; alert(t.errorNative);});
        return;
      }
    }

    // Fallback: Try native playback for other streams (M3U, MP4, TS)
    await tryNativePlay(url);
    spinner.style.display='none';
    return;

  }catch(err){
    console.error('Playback error final fallback:',err);
    spinner.style.display='none';
    alert('No se pudo reproducir este canal (Error de CORS/Formato/Seguridad).');
  }
}

/* ---------- Filtering ---------- */
function filterChannels(){
  const country = countrySelect.value;
  const group = categorySelect.value;
  const q = (searchInput.value||'').toLowerCase();

  const filtered = allChannels.filter(ch=>{
    const matchCountry = !country || ch.country === country;
    const matchGroup = !group || ch.group === group;
    const matchQuery = !q || ch.name.toLowerCase().includes(q);
    return matchCountry && matchGroup && matchQuery;
  });

  renderChannels(filtered);
  renderFsList(filtered);
}

/* ---------- Menu & Toggle Behaviors ---------- */

function showAllChannels() {
    countrySelect.value = '';
    categorySelect.value = '';
    searchInput.value = '';
    filterChannels(); 
}

function setActiveMenuButton(id){
    document.querySelectorAll('#bottomMenu .menu-btn').forEach(btn => btn.classList.remove('active'));
    if(id) document.getElementById(id).classList.add('active');
}

// ‚ò∞ Canales (Reloads the main list and ensures sidebar is open)
document.getElementById('btn-channels').addEventListener('click', ()=>{ 
    const t = translations[currentLang];
    // Open the sidebar if closed
    if (window.innerWidth < 900 && !leftPanel.classList.contains('active')) {
         leftPanel.classList.add('active'); 
         toggleBtn.textContent = t.toggleClose;
    }
    showAllChannels(); 
    setActiveMenuButton('btn-channels');
});

// ‚òÖ Favoritos (Opens the new modal)
document.getElementById('btn-favs').addEventListener('click', showFavoritesModal);

// ‚ü≤ Historial (Renders in sidebar and ensures sidebar is open)
document.getElementById('btn-hist').addEventListener('click', ()=>{ 
    const t = translations[currentLang];
    showHistory(); 
    setActiveMenuButton('btn-hist'); 
    
    // Ensure the sidebar opens when viewing history on mobile
    if (window.innerWidth < 900 && !leftPanel.classList.contains('active')) {
         leftPanel.classList.add('active'); 
         toggleBtn.textContent = t.toggleClose;
    }
});


function showHistory(){
  const hist = historyList.map(u=> allChannels.find(c=>c.url===u)).filter(Boolean);
  renderChannels(hist);
  renderFsList(hist);
}

/* mobile toggle logic */
toggleBtn.addEventListener('click', ()=>{
  const t = translations[currentLang];
  const isActive = leftPanel.classList.toggle('active');
  toggleBtn.textContent = isActive ? t.toggleClose : t.toggleOpen;
  
  if(window.innerWidth < 900) {
    setActiveMenuButton(isActive ? 'btn-channels' : null);
  } else {
    // Desktop: ensure list shows all channels when sidebar is manipulated
    showAllChannels();
  }
  
  // If we open the sidebar, we should show the default channels list
  if (isActive) {
      showAllChannels();
  }
});

/* Close modal listeners */
document.getElementById('closeFavModal').addEventListener('click', () => {
    favoritesModal.style.display = 'none';
    favoritesModal.setAttribute('aria-hidden', 'true');
    setActiveMenuButton(null); 
});

// Handle ESC key to close modal
document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape') {
        if (favoritesModal.style.display === 'flex') {
            favoritesModal.style.display = 'none';
            favoritesModal.setAttribute('aria-hidden', 'true');
            setActiveMenuButton(null);
        } else if (leftPanel.classList.contains('active')) {
             // Close sidebar too if open
            leftPanel.classList.remove('active');
            toggleBtn.textContent = translations[currentLang].toggleOpen;
            setActiveMenuButton(null);
        }
    }
});


/* ---------- FS menu behaviors ---------- */
document.addEventListener('fullscreenchange', ()=>{
  if(document.fullscreenElement){
    fsBtn.style.display = 'flex';
  } else {
    fsBtn.style.display = 'none';
    fsMenu.style.display = 'none';
  }
});
fsBtn.addEventListener('click', ()=>{ fsMenu.style.display = fsMenu.style.display==='block' ? 'none' : 'block'; });
fsSearch.addEventListener('input', ()=> {
  const q = fsSearch.value.toLowerCase();
  [...fsList.children].forEach(c => c.style.display = c.textContent.toLowerCase().includes(q) ? 'block' : 'none');
});


/* ---------- Small UX: keyboard navigation (TV remote simulation) ---------- */
document.addEventListener('keydown', (e)=>{
  const isListActive = leftPanel.classList.contains('active') || (window.innerWidth >= 900);

  if((e.key==='ArrowDown' || e.key==='ArrowUp') && isListActive && favoritesModal.style.display !== 'flex'){
    e.preventDefault();
    const visible = [...listEl.querySelectorAll('.channel')].filter(el=> el.offsetParent !== null);
    if(!visible.length) return;

    // Find active element, or the focused one
    let activeEl = document.activeElement;
    if(!activeEl || !activeEl.classList.contains('channel')) {
        activeEl = listEl.querySelector('.channel.active') || visible[0];
    }

    const idx = visible.findIndex(x => x === activeEl);
    let next = 0;
    if(idx===-1) next = 0;
    else if(e.key==='ArrowDown') next = Math.min(visible.length-1, idx+1);
    else next = Math.max(0, idx-1);

    visible[next].focus(); 
    visible[next].scrollIntoView({block:'center'});
  }

  if(e.key==='Enter' && document.activeElement && document.activeElement.classList.contains('channel') && favoritesModal.style.display !== 'flex'){
    document.activeElement.click();
  }
});

/* ---------- Search listeners ---------- */
searchInput.addEventListener('input', ()=> filterChannels());

/* ---------- Init ---------- */
setLanguage('es');
loadList();

/* ---------- PWA: Service Worker Registration (Single File) ---------- */
// Implementa la funcionalidad sin conexi√≥n (caching) de la PWA.
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=> {
    // Contenido del Service Worker como un string.
    const swScript = `
      const CACHE_NAME = 'iptv-player-cache-v4';
      const urlsToCache = [
        './', 
        'https://cdn.jsdelivr.net/npm/hls.js@latest' 
      ];

      self.addEventListener('install', (event) => {
        event.waitUntil(
          caches.open(CACHE_NAME).then((cache) => {
            return cache.addAll(urlsToCache).catch(err => {
              console.error('SW: Failed to cache some assets', err);
            });
          })
        );
        self.skipWaiting();
      });

      self.addEventListener('activate', (event) => {
        event.waitUntil(
          caches.keys().then((cacheNames) => {
            return Promise.all(
              cacheNames.filter(name => name !== CACHE_NAME).map(name => caches.delete(name))
            );
          })
        );
        self.clients.claim();
      });

      self.addEventListener('fetch', (event) => {
        if (event.request.mode === 'navigate' || event.request.destination === 'script' || event.request.destination === 'style') {
          event.respondWith(
            caches.match(event.request).then((response) => {
              return response || fetch(event.request).catch(() => {
                if (event.request.mode === 'navigate') {
                  return new Response('<h1>Sin conexi√≥n</h1><p>Esta aplicaci√≥n requiere conexi√≥n a Internet para cargar los canales, pero la interfaz principal est√° disponible (PWA).</p>', { headers: { 'Content-Type': 'text/html' } });
                }
              });
            })
          );
        }
      });
    `;

    try{
      const swBlob = new Blob([swScript], {type: 'application/javascript'});
      const swUrl = URL.createObjectURL(swBlob);
      navigator.serviceWorker.register(swUrl)
        .then(reg => console.log('Service Worker registrado con √©xito:', reg.scope))
        .catch(err => console.error('Fallo el registro del Service Worker:', err));
    }catch(e){ 
      console.warn('Fallo el registro del Service Worker (Inline Blob):',e); 
    }
  });
}
</script>
</body>
</html>
