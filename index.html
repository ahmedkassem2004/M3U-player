<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0"> 
<title>IPTV Web Player M3U</title>
<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
<style>
/* ------------------------------------------------------------------- */
/* ESTILOS BASE (MOBILE FIRST) */
/* ------------------------------------------------------------------- */
body {
    background: #0a0a0a;
    color: #fff;
    font-family: Arial, Helvetica, sans-serif;
    display: flex;
    flex-direction: column; 
    height: 100vh;
    width: 100vw;
    margin: 0;
    overflow: hidden; 
}

/* Panel Izquierdo (Lista de Canales y Controles) */
#left {
    width: 100%;
    height: 50vh; 
    max-height: 50vh;
    display: flex;
    flex-direction: column;
    border-right: none;
    border-bottom: 1px solid #222;
    transition: transform 0.3s ease-in-out;
    position: relative;
    z-index: 10;
}

/* Clase para ocultar el panel izquierdo en m√≥vil */
#left.hidden {
    transform: translateY(-100%);
    height: 0;
    max-height: 0;
    overflow: hidden;
}

/* Controles (Selectores y Buscador) */
#country-select, #category-select, #search {
    padding: 10px;
    background: #111;
    border: none;
    color: white;
    font-size: 15px;
    outline: none;
    width: 100%; 
    box-sizing: border-box;
    border-bottom: 1px solid #222;
}

#list {
    flex: 1;
    overflow-y: auto;
}

/* Estilos de la lista */
.channel {
    padding: 10px;
    border-bottom: 1px solid #222;
    cursor: pointer;
    transition: 0.2s;
    /* Flexbox para alinear logo y texto */
    display: flex; 
    align-items: center;
    white-space: nowrap; 
    overflow: hidden; 
}
.channel:hover {background: #1e1e1e;}
.active {background: #004d17 !important; border-left: 5px solid #22ff55;}

/* Estilo para el logo */
.channel-logo {
    width: 30px; 
    height: 30px;
    object-fit: contain; 
    margin-right: 10px;
    flex-shrink: 0; 
}

/* Estilo para el nombre del canal */
.channel span {
    flex-grow: 1;
    overflow: hidden;
    text-overflow: ellipsis;
}


/* Bot√≥n para Mostrar/Ocultar la lista en m√≥vil */
#toggle-list-btn {
    position: fixed;
    top: 10px;
    right: 10px;
    z-index: 20;
    padding: 10px 15px;
    background: #004d17;
    color: white;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-size: 16px;
    font-weight: bold;
    display: block; 
}

/* Reproductor de Video */
#player {
    flex: 1; 
    width: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
}

#video {
    max-width: 100%;
    max-height: 100%;
    width: 100%;
    height: 100%;
    object-fit: contain; 
}


/* ------------------------------------------------------------------- */
/* MEDIA QUERY: ESCRITORIO (a partir de 768px) */
/* ------------------------------------------------------------------- */
@media (min-width: 768px) {
    body {
        flex-direction: row; 
    }

    #left {
        width: 320px; 
        height: 100%;
        max-height: 100%;
        border-right: 1px solid #222;
        border-bottom: none;
        transform: none; 
    }

    /* Ocultar el bot√≥n en escritorio */
    #toggle-list-btn {
        display: none !important;
    }

    #left.hidden {
        transform: none;
        height: 100%;
        max-height: 100%;
        overflow: auto;
    }
}
</style>
</head>
<body>

<button id="toggle-list-btn">‚ò∞ Canales</button>

<div id="left">
    <select id="country-select" onchange="filterChannels()">
        <option value="">Cargando Pa√≠ses...</option>
    </select>
    
    <select id="category-select" onchange="filterChannels()">
        <option value="">Cargando Categor√≠as...</option>
    </select>
    
    <input type="text" id="search" placeholder="Buscar canal...">
    
    <div id="list"></div>
</div>

<div id="player">
    <video id="video" controls width="100%" height="100%"></video>
</div>

<script>
// √öNICA URL M3U utilizada para obtener todos los datos
const M3U_URL = "https://iptv-org.github.io/iptv/index.m3u"; 

let allChannels = []; 
let channelsDOM = []; 

// Referencias a elementos DOM
const list = document.getElementById("list");
const countrySelect = document.getElementById("country-select");
const categorySelect = document.getElementById("category-select");
const searchInput = document.getElementById("search");
const leftPanel = document.getElementById("left");
const toggleBtn = document.getElementById("toggle-list-btn");


/**
 * Funci√≥n auxiliar para extraer el valor de un atributo de la l√≠nea EXTINF.
 * @param {string} line - L√≠nea #EXTINF completa.
 * @param {string} attr - Nombre del atributo (ej. 'tvg-country').
 * @returns {string} El valor del atributo, o cadena vac√≠a si no se encuentra.
 */
const extractAttr = (line, attr) => {
    // Expresi√≥n regular para encontrar attr="value"
    const match = line.match(new RegExp(attr + '="([^"]*)"'));
    return match ? match[1].trim() : '';
};


/**
 * Carga el archivo M3U, lo parsea para obtener canales, pa√≠ses, categor√≠as y logos.
 */
async function loadList() {
    list.innerHTML = '<div style="padding: 10px; color: #22ff55;">Cargando lista de canales y datos de M3U...</div>';
    
    try {
        let text = await fetch(M3U_URL).then(r => r.text());
        let lines = text.split("\n");
        
        allChannels = [];
        const countries = new Set();
        const categories = new Set();

        for (let i = 0; i < lines.length; i++) {
            if (lines[i].startsWith("#EXTINF")) {
                let extinfLine = lines[i];
                let url = lines[i + 1] ? lines[i + 1].trim() : '';

                // 1. Extracci√≥n de atributos de la l√≠nea #EXTINF
                const name = extinfLine.split(",").pop().trim();
                const country = extractAttr(extinfLine, 'tvg-country').toUpperCase() || 'ZZ';
                const categoryName = extractAttr(extinfLine, 'group-title') || 'Otros';
                const logo = extractAttr(extinfLine, 'tvg-logo');

                if (name && url) {
                    allChannels.push({
                        name,
                        url,
                        country,
                        categoryName,
                        logo // URL del logo extra√≠da
                    });
                    countries.add(country);
                    categories.add(categoryName);
                }
            }
        }
        
        if (allChannels.length === 0) {
            list.innerHTML = '<div style="padding: 10px; color: red;">No se encontraron canales v√°lidos en el archivo M3U.</div>';
            return;
        }

        // 2. Poblar Selector de Pa√≠ses
        countrySelect.innerHTML = '<option value="">üåê Todos los Pa√≠ses (' + allChannels.length + ')</option>';
        Array.from(countries).sort().forEach(countryCode => {
            // Usamos el c√≥digo de pa√≠s directamente, ya que no tenemos la API de pa√≠ses.json
            let option = document.createElement("option");
            option.value = countryCode;
            option.innerText = countryCode; 
            countrySelect.appendChild(option);
        });
        
        // 3. Poblar Selector de Categor√≠as
        categorySelect.innerHTML = '<option value="">‚≠ê Todas las Categor√≠as</option>';
        Array.from(categories).sort().forEach(categoryName => {
            let option = document.createElement("option");
            option.value = categoryName;
            option.innerText = categoryName;
            categorySelect.appendChild(option);
        });


        // 4. Inicializaci√≥n
        filterChannels(); 
        setupMobileToggle();

    } catch (error) {
        console.error("Error al cargar o parsear el archivo M3U:", error);
        countrySelect.innerHTML = '<option value="">Error de Carga</option>';
        categorySelect.innerHTML = '<option value="">Error de Carga</option>';
        list.innerHTML = '<div style="padding: 10px; color: red;">Error al cargar los datos M3U.</div>';
    }
}

/**
 * Funci√≥n UNIFICADA para filtrar canales por Pa√≠s, Categor√≠a y B√∫squeda.
 */
function filterChannels() {
    const countryCode = countrySelect.value;
    const categoryName = categorySelect.value;
    const searchText = searchInput.value.toLowerCase();
    
    let channelsToShow = allChannels.filter(channel => {
        const matchesCountry = countryCode === '' || channel.country === countryCode;
        const matchesCategory = categoryName === '' || channel.categoryName === categoryName;
        const matchesSearch = channel.name.toLowerCase().includes(searchText);
        
        return matchesCountry && matchesCategory && matchesSearch;
    });

    renderChannels(channelsToShow);
}

/**
 * Renderiza los canales filtrados, incluyendo la l√≥gica para el logo.
 */
function renderChannels(channelsToShow) {
    list.innerHTML = "";
    channelsDOM = [];

    if (channelsToShow.length === 0) {
        list.innerHTML = `<div style="padding: 10px; color: #ffeb3b;">No hay canales disponibles para el filtro actual.</div>`;
        return;
    }

    channelsToShow.forEach(channel => {
        let div = document.createElement("div");
        div.className="channel";
        div.dataset.url = channel.url;
        div.onclick = () => play(div);

        // Integraci√≥n del logo con correcci√≥n de error de carga
        if (channel.logo) {
            // Si la imagen falla al cargar (ej. URL inv√°lida o CORS), "this.style.display='none';" la oculta.
            const logoHtml = `<img src="${channel.logo}" class="channel-logo" alt="${channel.name} Logo" onerror="this.style.display='none';">`;
            const nameHtml = `<span>${channel.name}</span>`;
            div.innerHTML = logoHtml + nameHtml;
        } else {
            // Si no hay logo, solo el nombre
            div.innerHTML = `<span>${channel.name}</span>`;
        }

        list.appendChild(div);
        channelsDOM.push(div);
    });
}


function play(div){
    // Ocultar la lista de canales al iniciar la reproducci√≥n en m√≥vil
    if (window.innerWidth < 768) {
        leftPanel.classList.add('hidden');
        toggleBtn.innerText = '‚ò∞ Canales';
    }

    // Resaltar canal activo
    channelsDOM.forEach(c=>c.classList.remove("active"));
    div.classList.add("active");

    var url = div.dataset.url;
    var video = document.getElementById('video');

    // Manejo de HLS.js (destruir/recrear)
    if (Hls.isSupported()) {
        if(video.hls){
             video.hls.destroy(); 
        }
        var hls = new Hls();
        hls.loadSource(url);
        hls.attachMedia(video);
        video.hls = hls; 
        video.play();
    } else if (video.canPlayType('application/vnd.apple.mpegurl')) {
        video.src = url;
        video.play();
    } else {
        alert("Video no compatible (HLS no soportado por este navegador).");
    }
}

/* ------------------------------------------------------------------- */
/* L√ìGICA RESPONSIVA Y TOGGLE M√ìVIL */
/* ------------------------------------------------------------------- */

function setupMobileToggle() {
    if (window.innerWidth < 768) {
        leftPanel.classList.add('hidden');
    }

    toggleBtn.addEventListener('click', () => {
        leftPanel.classList.toggle('hidden');
        toggleBtn.innerText = leftPanel.classList.contains('hidden') ? '‚ò∞ Canales' : 'X Cerrar';
    });

    window.addEventListener('resize', () => {
        if (window.innerWidth >= 768) {
            toggleBtn.style.display = 'none';
            leftPanel.classList.remove('hidden'); 
        } else {
            toggleBtn.style.display = 'block';
        }
    });
}

// Evento de b√∫squeda llama al filtro unificado
searchInput.addEventListener("input", filterChannels);

// Inicializaci√≥n
loadList();
</script>

</body>
</html>
