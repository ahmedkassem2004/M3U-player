<!DOCTYPE html>
<html lang="es">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title id="app-title">IPTV PLAYER</title>

<!-- App icons / PWA -->
<link rel="icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png" />
<link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/633/633600.png" />
<meta name="theme-color" content="#121212" />
<link rel="manifest" href='data:application/json,{"name":"IPTV Player","short_name":"IPTV","start_url":".","display":"standalone","background_color":"#121212","theme_color":"#121212","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/633/633600.png","sizes":"512x512","type":"image/png"}]}'>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>

<style>
:root{
  --bg-dark:#121212;
  --bg-medium:#1f1f1f;
  --border-soft:#2f2f2f;
  --accent:#00bcd4;
  --text:#eaeaea;
}
*{box-sizing:border-box}
html,body{height:100%;margin:0;background:var(--bg-dark);color:var(--text);font-family:Inter,Segoe UI,Roboto,Arial,sans-serif}
body{display:flex;flex-direction:column;overflow:hidden}

/* Mobile-first layout */
#toggle-list-btn{
  position:fixed;top:12px;right:12px;z-index:60;padding:10px 14px;background:var(--accent);color:#071018;border:none;border-radius:10px;cursor:pointer;box-shadow:0 8px 20px rgba(0,0,0,0.6)
}
.app{display:flex;flex-direction:column;height:100vh;width:100vw;gap:0}

/* Left panel */
#left{width:100%;height:44vh;max-height:44vh;background:var(--bg-medium);border-bottom:1px solid var(--border-soft);padding:12px;overflow:hidden;transition:transform .28s;display:flex;flex-direction:column}
#left.hidden{transform:translateY(-110%)}
#controls-container{display:flex;flex-direction:column;gap:8px;margin-bottom:8px}
select,input{width:100%;padding:10px;border-radius:8px;border:1px solid var(--border-soft);background:#0f1112;color:var(--text);outline:none}
#list{
  overflow-y:auto;
  flex:1;
  min-height:0;
  padding-right:8px;
}

/* Channel items */
.channel{display:flex;align-items:center;gap:12px;padding:10px;border-radius:8px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
.channel:hover{background:rgba(255,255,255,0.02)}
.channel.active{background:linear-gradient(90deg,rgba(0,188,212,0.08),rgba(0,188,212,0.03));border-left:4px solid var(--accent)}
.channel-logo{width:36px;height:36px;border-radius:6px;flex-shrink:0;background:#0b0b0b;display:flex;align-items:center;justify-content:center;overflow:hidden;color:#ccc;font-weight:bold;font-size:14px}
.channel-logo img{width:100%;height:100%;object-fit:contain;display:block}
.channel-name{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}

/* Player */
#playerWrap{flex:1;background:linear-gradient(180deg,#000,#050507);display:flex;align-items:center;justify-content:center;padding:12px;position:relative}
video{width:100%;height:100%;max-height:100%;border-radius:12px;background:#000;outline:none}
.overlay{position:absolute;top:14px;left:14px;background:rgba(0,0,0,0.6);padding:8px 12px;border-radius:8px;display:none;color:#ffdede}
.spinnerSmall{position:absolute;right:14px;top:14px;padding:6px 10px;border-radius:8px;background:rgba(255,255,255,0.04);color:#b6c0c7;display:none}

/* Bottom menu */
#bottomMenu{position:fixed;left:0;right:0;bottom:0;height:62px;background:linear-gradient(180deg,#0b0b0b,#0a0a0a);display:flex;align-items:center;justify-content:space-around;border-top:1px solid var(--border-soft);z-index:55}
.menu-btn{display:flex;flex-direction:column;align-items:center;font-size:12px;color:#bfc8cc;gap:4px}

/* Desktop */
@media(min-width:900px){
  .app{flex-direction:row}
  #left{width:360px;height:100%;max-height:100%}
  #playerWrap{flex:1;padding:18px}
  #toggle-list-btn{display:none}
  #bottomMenu{display:none}
}
</style>
</head>
<body>
<button id="toggle-list-btn">‚ò∞ Canales</button>

<div class="app" id="app">
  <aside id="left">
    <div id="controls-container">
      <select id="language-select" onchange="setLanguage(this.value)">
        <option value="es" selected>üá™üá∏ Espa√±ol</option>
        <option value="en">üá¨üáß English</option>
        <option value="pt">üáµüáπ Portugu√™s</option>
        <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
      </select>

      <select id="country-select" onchange="filterChannels()">
        <option value="" id="opt-all-countries">Cargando Pa√≠ses...</option>
      </select>

      <select id="category-select" onchange="filterChannels()">
        <option value="" id="opt-all-categories">Cargando Categor√≠as...</option>
      </select>

      <input id="search" placeholder="Buscar canal..." />
    </div>

    <div id="list"></div>
  </aside>

  <main id="playerWrap">
    <div style="width:100%;height:100%;max-width:1400px;max-height:85vh;position:relative">
      <video id="video" controls playsinline crossorigin="anonymous"></video>
      <div id="overlay" class="overlay"></div>
      <div id="spinner" class="spinnerSmall">Cargando‚Ä¶</div>
    </div>
  </main>
</div>

<nav id="bottomMenu">
  <div class="menu-btn" id="btn-channels">‚ò∞<span>Canales</span></div>
  <div class="menu-btn" id="btn-favs">‚òÖ<span>Favoritos</span></div>
  <div class="menu-btn" id="btn-hist">‚ü≤<span>Historial</span></div>
</nav>

<script>
/* IPTV SETTINGS */
const M3U_URL = "https://iptv-org.github.io/iptv/index.m3u";
const COUNTRIES_API = "https://iptv-org.github.io/api/countries.json";

/* DOM */
const video = document.getElementById('video');
const listEl = document.getElementById('list');
const countrySelect = document.getElementById('country-select');
const categorySelect = document.getElementById('category-select');
const searchInput = document.getElementById('search');
const overlay = document.getElementById('overlay');
const spinner = document.getElementById('spinner');
const toggleBtn = document.getElementById('toggle-list-btn');
const leftPanel = document.getElementById('left');

/* STATE */
let hls = null;
let allChannels = [];
let channelsDOM = [];
let countriesMap = {};
let currentLang = 'es';
let favorites = [];
let historyList = [];

/* TRANSLATIONS */
const translations = {
  es:{ loading:"Cargando lista...", noChannels:"No se encontraron canales.", toggleOpen:"‚ò∞ Canales", toggleClose:"X Cerrar", search:"Buscar canal..." },
  en:{ loading:"Loading list...", noChannels:"No channels found.", toggleOpen:"‚ò∞ Channels", toggleClose:"X Close", search:"Search channel..." },
  pt:{ loading:"Carregando lista...", noChannels:"Nenhum canal encontrado.", toggleOpen:"‚ò∞ Canais", toggleClose:"X Fechar", search:"Pesquisar canal..." },
  ar:{ loading:"ÿ¨ÿßÿ±Ÿç ÿßŸÑÿ™ÿ≠ŸÖŸäŸÑ...", noChannels:"ŸÑŸÖ Ÿäÿ™ŸÖ ÿßŸÑÿπÿ´Ÿàÿ± ÿπŸÑŸâ ÿßŸÑŸÇŸÜŸàÿßÿ™.", toggleOpen:"‚ò∞ ÿßŸÑŸÇŸÜŸàÿßÿ™", toggleClose:"X ÿ•ÿ∫ŸÑÿßŸÇ", search:"ÿßÿ®ÿ≠ÿ´ ÿπŸÜ ŸÇŸÜÿßÿ©..." }
};

/* LANGUAGE */
function setLanguage(lang){
  currentLang = lang;
  searchInput.placeholder = translations[lang].search;
}

/* UTILS */
async function fetchJSON(url){ const r = await fetch(url); return r.json(); }
function extractAttr(line,key){ const m=line.match(new RegExp(key+'="([^"]*)"')); return m?m[1]:""; }

/* LOAD LIST */
async function loadList(){
  listEl.innerHTML = `<div style="padding:12px;color:var(--accent)">${translations[currentLang].loading}</div>`;

  const [m3uText, countries] = await Promise.all([
    fetch(M3U_URL).then(r=>r.text()),
    fetchJSON(COUNTRIES_API)
  ]);

  countries.forEach(c=>countriesMap[c.code.toUpperCase()] = c.name);

  const lines = m3uText.split("\n");
  allChannels=[];
  const cSet=new Set();
  const gSet=new Set();

  for(let i=0;i<lines.length;i++){
    if(lines[i].startsWith("#EXTINF")){
      const L=lines[i];
      const name=L.split(",").pop().trim();
      const url=(lines[i+1]||"").trim();
      i++;
      if(!name||!url) continue;
      const logo=extractAttr(L,"tvg-logo");
      const country=extractAttr(L,"tvg-country").toUpperCase()||"OTROS";
      const group=extractAttr(L,"group-title")||"Otros";

      allChannels.push({name,logo,url,country,group});
      cSet.add(country);
      gSet.add(group);
    }
  }

  renderList(allChannels);
  fillFilters(cSet,gSet);
}

/* FILTERS */
function fillFilters(cSet,gSet){
  countrySelect.innerHTML = `<option value="">üåê Pa√≠ses (${allChannels.length})</option>`;
  [...cSet].sort().forEach(c=>{
    countrySelect.innerHTML += `<option value="${c}">${countriesMap[c]||c}</option>`;
  });

  categorySelect.innerHTML = `<option value="">‚≠ê Categor√≠as</option>`;
  [...gSet].sort().forEach(g=>{
    categorySelect.innerHTML += `<option value="${g}">${g}</option>`;
  });
}

/* SEARCH (DEBOUNCE) */
let searchTimer=null;
searchInput.addEventListener("input",()=>{
  clearTimeout(searchTimer);
  searchTimer=setTimeout(filterChannels,80);
});

/* FILTER CHANNELS */
function filterChannels(){
  const c=countrySelect.value;
  const g=categorySelect.value;
  const q=searchInput.value.toLowerCase();

  const filtered=allChannels.filter(ch=>{
    return (!c||ch.country===c)
        &&(!g||ch.group===g)
        &&(!q||ch.name.toLowerCase().includes(q));
  });

  renderList(filtered);
}

/* RENDER */
function renderList(channels){
  listEl.innerHTML="";
  channelsDOM=[];
  channels.forEach(ch=>{
    const div=document.createElement("div");
    div.className="channel";
    div.dataset.url=ch.url;

    const logo=document.createElement("div");
    logo.className="channel-logo";
    if(ch.logo){
      const img=document.createElement("img");
      img.src=ch.logo;
      img.onerror=()=>{img.remove();logo.textContent=ch.name.slice(0,2);}
      logo.appendChild(img);
    }else logo.textContent=ch.name.slice(0,2);

    const name=document.createElement("div");
    name.className="channel-name";
    name.textContent=ch.name;

    div.appendChild(logo);
    div.appendChild(name);
    div.onclick=()=>playChannel(ch,div);

    listEl.appendChild(div);
    channelsDOM.push(div);
  });
}

/* PLAY */
async function playChannel(ch,div){
  channelsDOM.forEach(c=>c.classList.remove("active"));
  if(div) div.classList.add("active");

  if(window.innerWidth<900){
    leftPanel.classList.add("hidden");
    toggleBtn.textContent = translations[currentLang].toggleOpen;
  }

  overlay.textContent=ch.name;
  overlay.style.display="block";
  setTimeout(()=>overlay.style.display="none",2500);

  spinner.style.display="block";

  if(hls){ hls.destroy(); hls=null; }
  video.pause();

  if(ch.url.includes(".m3u8") && Hls.isSupported()){
    hls=new Hls();
    hls.loadSource(ch.url);
    hls.attachMedia(video);
    hls.on(Hls.Events.MANIFEST_PARSED,()=>{spinner.style.display="none";video.play();});
  }else{
    video.src=ch.url;
    video.onloadeddata=()=>{spinner.style.display="none";video.play();}
  }
}

/* MOBILE */
toggleBtn.onclick=()=>{
  leftPanel.classList.toggle("hidden");
};

/* INIT */
setLanguage("es");
loadList();
</script>

</body>
</html>