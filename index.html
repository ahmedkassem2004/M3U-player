<!doctype html>
<html lang="es" class="h-full">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="theme-color" content="#0e1216"/>
<title>IPTV Player PWA</title>

<!-- TailwindCSS -->
<script src="https://cdn.tailwindcss.com"></script>
<script>
tailwind.config = {
  darkMode: 'media',
  theme: {
    extend: {
      colors: {
        accent: '#00c86b',
        panel: { light: '#f3f4f6', dark: '#161b22' },
        bg: { light: '#ffffff', dark: '#0d1117' },
        text: { light: '#111827', dark: '#e9eef1' }
      },
      borderRadius: { 'xl': '12px' }
    }
  }
}
</script>

<!-- Manifest inline -->
<link rel="manifest" href="data:application/json,{&quot;name&quot;:&quot;IPTV Player&quot;,&quot;short_name&quot;:&quot;IPTV&quot;,&quot;display&quot;:&quot;standalone&quot;,&quot;start_url&quot;:&quot;.&quot;,&quot;background_color&quot;:&quot;#0e1216&quot;,&quot;theme_color&quot;:&quot;#0e1216&quot;,&quot;icons&quot;:[{&quot;src&quot;:&quot;https://cdn-icons-png.flaticon.com/512/633/633600.png&quot;,&quot;sizes&quot;:&quot;512x512&quot;,&quot;type&quot;:&quot;image/png&quot;}]}"/>

<!-- Service Worker -->
<script>
if ('serviceWorker' in navigator) {
  window.addEventListener('load', ()=> navigator.serviceWorker.register(URL.createObjectURL(new Blob([`
    self.addEventListener('install', e=>self.skipWaiting());
    self.addEventListener('fetch', e=>{
      if (e.request.mode==='navigate')
        e.respondWith(fetch(e.request).catch(()=>new Response('<h1>Sin conexi√≥n</h1>',{headers:{'Content-Type':'text/html'}})));
    });
  `],{type:'text/javascript'}))));
}
</script>

<script src="https://cdn.jsdelivr.net/npm/hls.js@latest"></script>
</head>

<body class="h-full bg-bg-light dark:bg-bg-dark text-text-light dark:text-text-dark font-sans">
<!-- Pantalla de carga -->
<div id="loader" class="fixed inset-0 flex flex-col items-center justify-center bg-bg-light dark:bg-bg-dark z-50">
  <div class="w-16 h-16 border-4 border-gray-300 dark:border-gray-700 border-t-accent rounded-full animate-spin"></div>
  <p class="mt-4 text-gray-500 dark:text-gray-400 text-sm">Cargando IPTV Player...</p>
</div>

<!-- App -->
<div class="grid md:grid-cols-[360px_1fr] gap-4 h-screen p-4 opacity-0 transition-opacity duration-700" id="app">
  <!-- Panel izquierdo -->
  <div class="flex flex-col bg-panel-light dark:bg-panel-dark rounded-xl p-4 overflow-hidden">
    <div class="flex justify-between items-center mb-3">
      <h1 class="font-semibold text-lg">üåê IPTV ‚Äî Pa√≠ses</h1>
    </div>
    <div class="flex gap-2 mb-3">
      <button id="tabAll" class="flex-1 py-2 rounded-lg bg-accent text-white font-medium">Canales</button>
      <button id="tabFav" class="flex-1 py-2 rounded-lg bg-gray-200 dark:bg-gray-800">Favoritos</button>
      <button id="tabHist" class="flex-1 py-2 rounded-lg bg-gray-200 dark:bg-gray-800">Historial</button>
    </div>

    <div>
      <button id="selectedCountry" class="w-full py-2 px-3 rounded-md border dark:border-gray-700 text-left bg-gray-100 dark:bg-gray-900 mb-2">Todos los pa√≠ses ‚ñº</button>
      <div id="dropdown" class="hidden bg-gray-50 dark:bg-gray-900 rounded-lg shadow-inner max-h-48 overflow-y-auto"></div>
    </div>

    <input id="searchInput" placeholder="Buscar canal..." class="w-full p-2 rounded-md border dark:border-gray-700 bg-gray-100 dark:bg-gray-900 mb-3" />
    <div id="channelList" class="overflow-y-auto flex-1 space-y-2 pr-2"></div>
  </div>

  <!-- Panel derecho -->
  <div class="flex flex-col bg-panel-light dark:bg-panel-dark rounded-xl p-4 relative">
    <div class="relative flex-1 bg-black rounded-xl overflow-hidden flex items-center justify-center">
      <video id="player" controls playsinline crossorigin="anonymous" class="w-full h-full rounded-xl bg-black"></video>
      <div id="overlay" class="absolute top-3 left-3 bg-black/60 text-white px-3 py-1.5 rounded-md hidden"></div>
      <div id="spinner" class="absolute top-3 right-3 text-sm text-gray-400 hidden">Cargando‚Ä¶</div>
      <button id="fsBtn" class="hidden absolute bottom-4 right-4 bg-accent text-white w-12 h-12 rounded-full text-2xl flex items-center justify-center">üì∫</button>
      <div id="fsMenu" class="hidden absolute bottom-20 right-4 bg-gray-900/90 text-white rounded-lg p-3 w-72 max-h-[60vh] overflow-y-auto">
        <input id="fsSearch" placeholder="Buscar canal..." class="w-full mb-2 p-1.5 rounded-md bg-gray-800 border border-gray-700 text-sm" />
        <div id="fsList" class="space-y-1"></div>
      </div>
    </div>
  </div>
</div>

<script>
(async function(){
  const loader=document.getElementById("loader");
  const app=document.getElementById("app");
  setTimeout(()=>{loader.remove();app.style.opacity="1";},2000);

  const M3U="https://iptv-org.github.io/iptv/index.country.m3u";
  const player=document.getElementById("player");
  const list=document.getElementById("channelList");
  const search=document.getElementById("searchInput");
  const overlay=document.getElementById("overlay");
  const spinner=document.getElementById("spinner");
  const fsBtn=document.getElementById("fsBtn");
  const fsMenu=document.getElementById("fsMenu");
  const fsList=document.getElementById("fsList");
  const fsSearch=document.getElementById("fsSearch");
  const sel=document.getElementById("selectedCountry");
  const drop=document.getElementById("dropdown");
  const tabAll=document.getElementById("tabAll");
  const tabFav=document.getElementById("tabFav");
  const tabHist=document.getElementById("tabHist");

  let hls=null,channels=[],countries=new Set();
  let favoritos=JSON.parse(localStorage.getItem("favoritos")||"[]");
  let historial=JSON.parse(localStorage.getItem("historial")||"[]");

  async function fetchText(url){const res=await fetch(url);return await res.text();}
  function parseM3U(text){
    const lines=text.split(/\r?\n/),out=[];
    for(let i=0;i<lines.length;i++){
      const L=lines[i].trim();if(!L)continue;
      if(L.startsWith("#EXTINF")){
        const name=L.substring(L.indexOf(",")+1).trim();
        const logo=L.match(/tvg-logo="([^"]+)"/)?.[1]||null;
        const country=L.match(/group-title="([^"]+)"/)?.[1]||"Otros";
        let j=i+1;while(j<lines.length&&lines[j].trim()==="")j++;
        const url=lines[j]||"";
        out.push({name,logo,url,country});
        countries.add(country);
      }
    }
    return out;
  }

  try{
    const txt=await fetchText(M3U);
    channels=parseM3U(txt);
  }catch(e){
    list.innerHTML="<div class='text-red-400 p-3'>Error cargando lista</div>";
    return;
  }

  function createChan(item){
    const el=document.createElement("div");
    el.className="flex justify-between items-center bg-gray-100 dark:bg-gray-800 hover:bg-gray-200 dark:hover:bg-gray-700 p-2 rounded-md cursor-pointer transition";
    const left=document.createElement("div");
    left.className="flex items-center gap-2";
    const logo=document.createElement("div");
    logo.className="w-8 h-8 rounded-full bg-gray-300 dark:bg-gray-700 flex items-center justify-center text-xs text-gray-700 dark:text-gray-300";
    if(item.logo){const img=document.createElement("img");img.src=item.logo;img.className="w-full h-full object-contain";img.onerror=()=>{img.remove();logo.textContent=item.name.slice(0,2)};logo.appendChild(img);}
    else logo.textContent=item.name.slice(0,2);
    const name=document.createElement("div");
    name.textContent=item.name;name.className="truncate w-44 text-sm";
    left.append(logo,name);

    const fav=document.createElement("button");
    fav.className="text-lg";fav.textContent=favoritos.includes(item.url)?"‚òÖ":"‚òÜ";
    fav.onclick=(ev)=>{
      ev.stopPropagation();
      if(favoritos.includes(item.url)){favoritos=favoritos.filter(f=>f!==item.url);fav.textContent="‚òÜ";}
      else{favoritos.push(item.url);fav.textContent="‚òÖ";}
      localStorage.setItem("favoritos",JSON.stringify(favoritos));
    };

    el.append(left,fav);
    el.onclick=()=>play(item,el);
    el._country=item.country;
    el._url=item.url;
    return el;
  }

  function render(type="all"){
    list.innerHTML="";fsList.innerHTML="";
    let arr=channels;
    if(type==="fav")arr=channels.filter(c=>favoritos.includes(c.url));
    if(type==="hist")arr=channels.filter(c=>historial.includes(c.url));
    arr.forEach(ch=>{
      const el=createChan(ch);
      list.appendChild(el);
      const fsEl=createChan(ch);
      fsList.appendChild(fsEl);
    });
  }
  render();

  function play(ch,el){
    document.querySelectorAll(".chan").forEach(c=>c.classList.remove("bg-gray-200","dark:bg-gray-700"));
    el.classList.add("bg-gray-200","dark:bg-gray-700");
    overlay.textContent=ch.name;
    overlay.classList.remove("hidden");
    setTimeout(()=>overlay.classList.add("hidden"),3000);
    spinner.classList.remove("hidden");
    if(hls){hls.destroy();hls=null;}
    if(Hls.isSupported()){
      hls=new Hls();hls.loadSource(ch.url);hls.attachMedia(player);
      hls.on(Hls.Events.MANIFEST_PARSED,()=>{spinner.classList.add("hidden");player.play();});
    }else{player.src=ch.url;player.play();spinner.classList.add("hidden");}
    if(!historial.includes(ch.url)){
      historial.unshift(ch.url);
      if(historial.length>50)historial.pop();
      localStorage.setItem("historial",JSON.stringify(historial));
    }
  }

  search.oninput=()=>{const q=search.value.toLowerCase();[...list.children].forEach(c=>c.style.display=c.textContent.toLowerCase().includes(q)?"flex":"none");};
  fsSearch.oninput=()=>{const q=fsSearch.value.toLowerCase();[...fsList.children].forEach(c=>c.style.display=c.textContent.toLowerCase().includes(q)?"flex":"none");};

  sel.onclick=()=>drop.classList.toggle("hidden");
  function fillCountries(){
    const all=document.createElement("div");
    all.textContent="Todos los pa√≠ses";
    all.className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer";
    all.onclick=()=>filter("Todos los pa√≠ses",all);
    drop.appendChild(all);
    countries.forEach(ct=>{
      const d=document.createElement("div");
      d.textContent=ct;
      d.className="p-2 hover:bg-gray-200 dark:hover:bg-gray-700 cursor-pointer";
      d.onclick=()=>filter(ct,d);
      drop.appendChild(d);
    });
  }
  function filter(ct,btn){
    sel.textContent=ct+" ‚ñº";
    [...drop.children].forEach(d=>d.classList.remove("bg-accent","text-white"));
    btn.classList.add("bg-accent","text-white");
    [...list.children].forEach(el=>el.style.display=(ct==="Todos los pa√≠ses"||el._country===ct)?"flex":"none");
    drop.classList.add("hidden");
  }
  fillCountries();

  tabAll.onclick=()=>{tabAll.classList.add("bg-accent","text-white");tabFav.classList.remove("bg-accent","text-white");tabHist.classList.remove("bg-accent","text-white");render("all");};
  tabFav.onclick=()=>{tabFav.classList.add("bg-accent","text-white");tabAll.classList.remove("bg-accent","text-white");tabHist.classList.remove("bg-accent","text-white");render("fav");};
  tabHist.onclick=()=>{tabHist.classList.add("bg-accent","text-white");tabAll.classList.remove("bg-accent","text-white");tabFav.classList.remove("bg-accent","text-white");render("hist");};

  document.addEventListener("fullscreenchange",()=>{
    if(document.fullscreenElement){fsBtn.classList.remove("hidden");}
    else{fsBtn.classList.add("hidden");fsMenu.classList.add("hidden");}
  });
  fsBtn.onclick=()=>fsMenu.classList.toggle("hidden");
})();
</script>
</body>
</html>